<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ“ä½œæ—¥å¿— - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/get-logs-style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>åä½œç¼–è¾‘ç³»ç»Ÿ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">æ“ä½œæ—¥å¿—</span>
                    <a href="dashboard.html" class="btn btn-secondary">è¿”å›å·¥ä½œå°</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="logs-container">
                <div class="logs-header">
                    <h2>æ“ä½œæ—¥å¿—</h2>
                    <p>æŸ¥çœ‹æ‚¨çš„æ‰€æœ‰æ“ä½œè®°å½•</p>
                </div>

                <div class="logs-content">
                    <div class="logs-actions">
                        <div>
                            <button onclick="refreshLogs()" class="btn btn-outline">ğŸ”„ åˆ·æ–°</button>
                        </div>
                        <div class="logs-count">
                            å…± <span id="totalLogs">0</span> æ¡è®°å½•
                        </div>
                    </div>

                    <div id="logsTableContainer">
                        <div class="loading-state" id="loadingState">
                            <div class="icon">â³</div>
                            <p>æ­£åœ¨åŠ è½½æ“ä½œæ—¥å¿—...</p>
                        </div>

                        <table class="logs-table" id="logsTable" style="display: none;">
                            <thead>
                            <tr>
                                <th>æ“ä½œæ—¶é—´</th>
                                <th>æ“ä½œç±»å‹</th>
                                <th>èµ„æºç±»å‹</th>
                                <th>èµ„æºID</th>
                                <th>æ“ä½œè¯¦æƒ…</th>
                            </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            <!-- æ—¥å¿—æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>

                        <div class="empty-state" id="emptyState" style="display: none;">
                            <div class="icon">ğŸ“</div>
                            <h3>æš‚æ— æ“ä½œè®°å½•</h3>
                            <p>æ‚¨è¿˜æ²¡æœ‰ä»»ä½•æ“ä½œè®°å½•ï¼Œå¼€å§‹ä½¿ç”¨ç³»ç»Ÿåè¿™é‡Œä¼šæ˜¾ç¤ºæ‚¨çš„æ“ä½œæ—¥å¿—ã€‚</p>
                        </div>
                    </div>

                    <div class="pagination" id="pagination" style="display: none;">
                        <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div id="message" class="message"></div>
            </div>
        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script>
    let currentLogs = [];
    const logsPerPage = 10;
    let currentPage = 1;

    // é¡µé¢åŠ è½½æ—¶è·å–æ“ä½œæ—¥å¿—
    document.addEventListener('DOMContentLoaded', async function() {
        if (!checkAuth()) {
            return;
        }

        await loadOperationLogs();
    });

    // åŠ è½½æ“ä½œæ—¥å¿—
    async function loadOperationLogs() {
        try {
            showLoadingState();

            const response = await user.getOperationLogs();
            console.log('æ“ä½œæ—¥å¿—å“åº”:', response);

            if (response.success && response.data) {
                // ç›´æ¥ä½¿ç”¨response.dataï¼Œå› ä¸ºç°åœ¨è¿”å›çš„æ˜¯æ•°ç»„
                currentLogs = Array.isArray(response.data) ? response.data : [];
                console.log('è§£æåçš„æ—¥å¿—æ•°æ®:', currentLogs);

                displayLogs(currentLogs);
                updateLogsCount(currentLogs.length);

                if (currentLogs.length === 0) {
                    showEmptyState();
                } else {
                    showLogsTable();
                    setupPagination(currentLogs.length);
                }

                showMessage('æ“ä½œæ—¥å¿—åŠ è½½æˆåŠŸ', 'success');
            } else {
                showMessage('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                showEmptyState();
            }
        } catch (error) {
            console.error('åŠ è½½æ“ä½œæ—¥å¿—å¼‚å¸¸:', error);
            showMessage('åŠ è½½æ“ä½œæ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            showEmptyState();
        }
    }

    // æ˜¾ç¤ºæ—¥å¿—æ•°æ®
    function displayLogs(logs) {
        const tableBody = document.getElementById('logsTableBody');
        tableBody.innerHTML = '';

        // è®¡ç®—åˆ†é¡µ
        const startIndex = (currentPage - 1) * logsPerPage;
        const endIndex = Math.min(startIndex + logsPerPage, logs.length);
        const pageLogs = logs.slice(startIndex, endIndex);

        if (pageLogs.length === 0) {
            showEmptyState();
            return;
        }

        pageLogs.forEach(log => {
            const row = document.createElement('tr');

            // æ ¼å¼åŒ–æ“ä½œæ—¶é—´
            let operationTime = '-';
            if (log.operationTime) {
                try {
                    // å¤„ç†ä¸åŒçš„æ—¶é—´æ ¼å¼
                    if (typeof log.operationTime === 'string') {
                        operationTime = new Date(log.operationTime).toLocaleString('zh-CN');
                    } else if (log.operationTime instanceof Array) {
                        // å¦‚æœæ˜¯æ•°ç»„æ ¼å¼ [2024, 1, 15, 10, 30, 0]
                        operationTime = new Date(...log.operationTime).toLocaleString('zh-CN');
                    }
                } catch (e) {
                    console.warn('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', e);
                    operationTime = String(log.operationTime);
                }
            }

            // æ ¹æ®æ“ä½œç±»å‹è®¾ç½®æ ·å¼
            const operationClass = getOperationClass(log.operation);

            row.innerHTML = `
                <td>${operationTime}</td>
                <td><span class="operation-type ${operationClass}">${log.operation}</span></td>
                <td>${log.resourceType || '-'}</td>
                <td>${log.resourceId || '-'}</td>
                <td>${log.details || '-'}</td>
            `;

            tableBody.appendChild(row);
        });
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoadingState() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('logsTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('logsTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
    }

    // æ˜¾ç¤ºæ—¥å¿—è¡¨æ ¼
    function showLogsTable() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('logsTable').style.display = 'table';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('pagination').style.display = 'flex';
    }

    // è·å–æ“ä½œç±»å‹çš„CSSç±»
    function getOperationClass(operation) {
        const operationMap = {
            'USER_LOGIN': 'operation-login',
            'USER_REGISTER': 'operation-register',
            'UPDATE_PROFILE': 'operation-update',
            'UPLOAD_AVATAR': 'operation-upload',
            'RESET_PASSWORD': 'operation-reset',
            'CHANGE_ROLE': 'operation-update',
            'REQUEST_ROLE_UPGRADE': 'operation-update'
        };
        return operationMap[operation] || 'operation-update';
    }

    // æ›´æ–°æ—¥å¿—æ•°é‡æ˜¾ç¤º
    function updateLogsCount(count) {
        document.getElementById('totalLogs').textContent = count;
    }

    // è®¾ç½®åˆ†é¡µ
    function setupPagination(totalLogs) {
        const totalPages = Math.ceil(totalLogs / logsPerPage);
        const pagination = document.getElementById('pagination');

        if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
        }

        let paginationHTML = '';

        // ä¸Šä¸€é¡µæŒ‰é’®
        if (currentPage > 1) {
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="btn btn-outline">ä¸Šä¸€é¡µ</button>`;
        }

        // é¡µç æŒ‰é’®
        for (let i = Math.max(1, currentPage - 5); i <= Math.min(totalPages, currentPage + 5); i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="btn btn-primary" disabled>${i}</button>`;
            } else {
                paginationHTML += `<button onclick="changePage(${i})" class="btn btn-outline">${i}</button>`;
            }
        }

        // ä¸‹ä¸€é¡µæŒ‰é’®
        if (currentPage < totalPages) {
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="btn btn-outline">ä¸‹ä¸€é¡µ</button>`;
        }

        pagination.innerHTML = paginationHTML;
        pagination.style.display = 'flex';
    }

    // åˆ‡æ¢é¡µç 
    function changePage(page) {
        currentPage = page;
        displayLogs(currentLogs);
        setupPagination(currentLogs.length);

        // æ»šåŠ¨åˆ°è¡¨æ ¼é¡¶éƒ¨
        document.getElementById('logsTable').scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ·æ–°æ—¥å¿—
    async function refreshLogs() {
        currentPage = 1;
        await loadOperationLogs();
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';

        setTimeout(() => {
            messageEl.style.display = 'none';
        }, type === 'success' ? 3000 : 5000);
    }
</script>
</body>
</html>