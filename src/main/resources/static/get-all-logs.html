<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†å‘˜æ“ä½œæ—¥å¿— - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/get-all-logs-style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>åä½œç¼–è¾‘ç³»ç»Ÿ - ç®¡ç†å‘˜ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">æ“ä½œæ—¥å¿—ç®¡ç†</span>
                    <a href="dashboard.html" class="btn btn-secondary">è¿”å›å·¥ä½œå°</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="logs-container">
                <div class="logs-header">
                    <h2>ç®¡ç†å‘˜æ“ä½œæ—¥å¿—</h2>
                    <p>æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·çš„æ“ä½œè®°å½•</p>
                </div>

                <div class="logs-content">
                    <!-- æœç´¢åŒºåŸŸ -->
                    <div class="search-section">
                        <h3 style="margin-bottom: 1rem; color: #495057;">ç”¨æˆ·æœç´¢</h3>
                        <div class="search-form">
                            <div class="form-group">
                                <label for="userIdInput">æœç´¢ç”¨æˆ·ID</label>
                                <input type="number" id="userIdInput" placeholder="è¾“å…¥ç”¨æˆ·IDè¿›è¡Œæœç´¢"
                                       class="form-control" min="1">
                            </div>
                            <div class="form-group">
                                <label for="userSearch">æœç´¢ç”¨æˆ·å</label>
                                <input type="text" id="userSearch" placeholder="è¾“å…¥ç”¨æˆ·åè¿›è¡Œæœç´¢"
                                       class="form-control">
                                <div class="user-selection" id="userSelection"></div>
                            </div>
                            <button type="button" onclick="searchUserLogs()" class="btn btn-primary">
                                ğŸ” æœç´¢æ—¥å¿—
                            </button>
                            <button type="button" onclick="clearSearch()" class="btn btn-outline">
                                ğŸ—‘ï¸ æ¸…é™¤æœç´¢
                            </button>
                        </div>
                    </div>

                    <div class="logs-actions">
                        <div class="logs-count">
                            å…± <span id="totalLogs">0</span> æ¡è®°å½•
                        </div>
                    </div>

                    <div id="logsTableContainer">
                        <div class="loading-state" id="loadingState">
                            <div class="icon">â³</div>
                            <p>æ­£åœ¨åŠ è½½æ“ä½œæ—¥å¿—...</p>
                        </div>

                        <table class="logs-table" id="logsTable" style="display: none;">
                            <thead>
                            <tr>
                                <th>æ“ä½œæ—¶é—´</th>
                                <th>ç”¨æˆ·ID</th>
                                <th>ç”¨æˆ·å</th>
                                <th>æ“ä½œç±»å‹</th>
                                <th>èµ„æºç±»å‹</th>
                                <th>èµ„æºID</th>
                                <th>æ“ä½œè¯¦æƒ…</th>
                            </tr>
                            </thead>
                            <tbody id="logsTableBody">
                            <!-- æ—¥å¿—æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€å¡«å…… -->
                            </tbody>
                        </table>

                        <div class="empty-state" id="emptyState" style="display: none;">
                            <div class="icon">ğŸ“</div>
                            <h3>æš‚æ— æ“ä½œè®°å½•</h3>
                            <p id="emptyStateMessage">è¯·æœç´¢ç”¨æˆ·æŸ¥çœ‹æ“ä½œæ—¥å¿—</p>
                        </div>
                    </div>

                    <div class="pagination" id="pagination" style="display: none;">
                        <!-- åˆ†é¡µæ§ä»¶å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>

                <div id="message" class="message"></div>
            </div>
        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script>
    let currentLogs = [];
    let currentUserId = null;
    const logsPerPage = 10;
    let currentPage = 1;

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æƒé™å¹¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', async function() {
        if (!checkAuth()) {
            return;
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¸ºç®¡ç†å‘˜
        await checkAdminPermission();
        setupEventListeners();
    });

    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
    async function checkAdminPermission() {
        try {
            const response = await user.getProfile();
            console.log('è·å–ç”¨æˆ·èµ„æ–™å“åº”:', response);
            const userData = response.data;

            const userRole = userData.role || '';

            if (!userRole.includes('ADMIN')) {
                showMessage('æƒé™ä¸è¶³ï¼šåªæœ‰ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ­¤é¡µé¢', 'error');
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
                return false;
            }

            return true;
        } catch (error) {
            console.error('æ£€æŸ¥æƒé™å¼‚å¸¸:', error);
            showMessage('æ£€æŸ¥æƒé™æ—¶å‘ç”Ÿé”™è¯¯', 'error');
            return false;
        }
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // ç”¨æˆ·æœç´¢è¾“å…¥ç›‘å¬
        document.getElementById('userSearch').addEventListener('input', function(e) {
            // è¿™é‡Œå¯ä»¥å®ç°ç”¨æˆ·æœç´¢åŠŸèƒ½ï¼Œç”±äºæ²¡æœ‰ç”¨æˆ·åˆ—è¡¨APIï¼Œæš‚æ—¶ç•™ç©º
            // å®é™…é¡¹ç›®ä¸­å¯ä»¥è°ƒç”¨ç”¨æˆ·æœç´¢API
        });

        // ç”¨æˆ·IDè¾“å…¥ç›‘å¬
        document.getElementById('userIdInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUserLogs();
            }
        });

        document.getElementById('userSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchUserLogs();
            }
        });
    }

    // æœç´¢ç”¨æˆ·æ—¥å¿—
    async function searchUserLogs() {
        const userSearch = document.getElementById('userSearch').value.trim();
        const userIdInput = document.getElementById('userIdInput').value.trim();

        if (!userSearch && !userIdInput) {
            showMessage('è¯·è¾“å…¥ç”¨æˆ·IDæˆ–ç”¨æˆ·å', 'error');
            return;
        }

        else if (userSearch) {
            try {
                const response = await user.getProfileByUsername(userSearch);
                console.log('ç”¨æˆ·èµ„æ–™å“åº”:', response);

                if (response.success && response.data) {
                    userData = response.data;
                    const userId = parseInt(userData.userId);
                    if (isNaN(userId) || userId <= 0) {
                        showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·ID', 'error');
                        return;
                    }

                    await loadUserLogs(userId);
                } else {
                    showMessage(response.message, 'error');
                    showEmptyState();
                }
            }  catch (error) {
                showMessage(error.message, 'error');
                showEmptyState();
            }
        }

        else {
            const userId = parseInt(userIdInput);
            if (isNaN(userId) || userId <= 0) {
                showMessage('è¯·è¾“å…¥æœ‰æ•ˆçš„ç”¨æˆ·ID', 'error');
                return;
            }

            await loadUserLogs(userId);
        }
    }

    // åŠ è½½æŒ‡å®šç”¨æˆ·çš„æ“ä½œæ—¥å¿—
    async function loadUserLogs(userId) {
        try {
            showLoadingState();

            const response = await user.getAllOperationLogs(userId);
            console.log('ç”¨æˆ·æ“ä½œæ—¥å¿—å“åº”:', response);

            if (response.success && response.data) {
                // ç›´æ¥ä½¿ç”¨response.dataï¼Œå› ä¸ºç°åœ¨è¿”å›çš„æ˜¯æ•°ç»„
                currentLogs = Array.isArray(response.data) ? response.data : [];
                console.log('è§£æåçš„æ—¥å¿—æ•°æ®:', currentLogs);

                displayLogs(currentLogs);
                updateLogsCount(currentLogs.length);

                if (currentLogs.length === 0) {
                    showEmptyState();
                } else {
                    showLogsTable();
                    setupPagination(currentLogs.length);
                }

                showMessage('æ“ä½œæ—¥å¿—åŠ è½½æˆåŠŸ', 'success');
            } else {
                showMessage('åŠ è½½æ“ä½œæ—¥å¿—å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                showEmptyState('åŠ è½½æ—¥å¿—å¤±è´¥');
            }
        } catch (error) {
            console.error('åŠ è½½æ“ä½œæ—¥å¿—å¼‚å¸¸:', error);
            showMessage('åŠ è½½æ“ä½œæ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            showEmptyState('åŠ è½½æ—¥å¿—æ—¶å‘ç”Ÿé”™è¯¯');
        }
    }

    // æ˜¾ç¤ºæ—¥å¿—æ•°æ®
    function displayLogs(logs) {
        const tableBody = document.getElementById('logsTableBody');
        tableBody.innerHTML = '';

        // è®¡ç®—åˆ†é¡µ
        const startIndex = (currentPage - 1) * logsPerPage;
        const endIndex = Math.min(startIndex + logsPerPage, logs.length);
        const pageLogs = logs.slice(startIndex, endIndex);

        if (pageLogs.length === 0) {
            showEmptyState();
            return;
        }

        pageLogs.forEach(log => {
            const row = document.createElement('tr');

            // æ ¼å¼åŒ–æ“ä½œæ—¶é—´
            let operationTime = '-';
            if (log.operationTime) {
                try {
                    if (typeof log.operationTime === 'string') {
                        operationTime = new Date(log.operationTime).toLocaleString('zh-CN');
                    } else if (log.operationTime instanceof Array) {
                        operationTime = new Date(...log.operationTime).toLocaleString('zh-CN');
                    }
                } catch (e) {
                    console.warn('æ—¶é—´æ ¼å¼åŒ–é”™è¯¯:', e);
                    operationTime = String(log.operationTime);
                }
            }

            // æ ¹æ®æ“ä½œç±»å‹è®¾ç½®æ ·å¼
            const operationClass = getOperationClass(log.operation);

            row.innerHTML = `
                <td>${operationTime}</td>
                <td><span class="user-info-badge">${log.userId}</span></td>
                <td>${log.username || '-'}</td>
                <td><span class="operation-type ${operationClass}">${log.operation}</span></td>
                <td>${log.resourceType || '-'}</td>
                <td>${log.resourceId || '-'}</td>
                <td>${log.details || '-'}</td>
            `;

            tableBody.appendChild(row);
        });
    }

    // æ¸…é™¤æœç´¢
    function clearSearch() {
        document.getElementById('userIdInput').value = '';
        document.getElementById('userSearch').value = '';
        currentLogs = [];
        currentUserId = null;
     
        document.getElementById('totalLogs').textContent = '0';

        showEmptyState('è¯·æœç´¢ç”¨æˆ·æŸ¥çœ‹æ“ä½œæ—¥å¿—');
        showMessage('æœç´¢å·²æ¸…é™¤', 'info');
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoadingState() {
        document.getElementById('loadingState').style.display = 'block';
        document.getElementById('logsTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('pagination').style.display = 'none';
    }

    // æ˜¾ç¤ºç©ºçŠ¶æ€
    function showEmptyState(message = 'æš‚æ— æ“ä½œè®°å½•') {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('logsTable').style.display = 'none';
        document.getElementById('emptyState').style.display = 'block';
        document.getElementById('pagination').style.display = 'none';
        document.getElementById('emptyStateMessage').textContent = message;
    }

    // æ˜¾ç¤ºæ—¥å¿—è¡¨æ ¼
    function showLogsTable() {
        document.getElementById('loadingState').style.display = 'none';
        document.getElementById('logsTable').style.display = 'table';
        document.getElementById('emptyState').style.display = 'none';
        document.getElementById('pagination').style.display = 'flex';
    }

    // è·å–æ“ä½œç±»å‹çš„CSSç±»
    function getOperationClass(operation) {
        const operationMap = {
            'USER_LOGIN': 'operation-login',
            'USER_REGISTER': 'operation-register',
            'UPDATE_PROFILE': 'operation-update',
            'UPLOAD_AVATAR': 'operation-upload',
            'RESET_PASSWORD': 'operation-reset',
            'CHANGE_ROLE': 'operation-change-role'
        };
        return operationMap[operation] || 'operation-update';
    }

    // æ›´æ–°æ—¥å¿—æ•°é‡æ˜¾ç¤º
    function updateLogsCount(count) {
        document.getElementById('totalLogs').textContent = count;
    }

    // è®¾ç½®åˆ†é¡µ
    function setupPagination(totalLogs) {
        const totalPages = Math.ceil(totalLogs / logsPerPage);
        const pagination = document.getElementById('pagination');

        if (totalPages <= 1) {
            pagination.style.display = 'none';
            return;
        }

        let paginationHTML = '';

        // ä¸Šä¸€é¡µæŒ‰é’®
        if (currentPage > 1) {
            paginationHTML += `<button onclick="changePage(${currentPage - 1})" class="btn btn-outline">ä¸Šä¸€é¡µ</button>`;
        }

        // é¡µç æŒ‰é’®
        for (let i = Math.max(1, currentPage - 5); i <= Math.min(totalPages, currentPage + 5); i++) {
            if (i === currentPage) {
                paginationHTML += `<button class="btn btn-primary" disabled>${i}</button>`;
            } else {
                paginationHTML += `<button onclick="changePage(${i})" class="btn btn-outline">${i}</button>`;
            }
        }

        // ä¸‹ä¸€é¡µæŒ‰é’®
        if (currentPage < totalPages) {
            paginationHTML += `<button onclick="changePage(${currentPage + 1})" class="btn btn-outline">ä¸‹ä¸€é¡µ</button>`;
        }

        pagination.innerHTML = paginationHTML;
        pagination.style.display = 'flex';
    }

    // åˆ‡æ¢é¡µç 
    function changePage(page) {
        currentPage = page;
        displayLogs(currentLogs);
        setupPagination(currentLogs.length);
        document.getElementById('logsTable').scrollIntoView({ behavior: 'smooth' });
    }

    // åˆ·æ–°æ—¥å¿—
    async function refreshLogs() {
        if (currentUserId) {
            currentPage = 1;
            await loadUserLogs(currentUserId);
        } else {
            showMessage('è¯·å…ˆæœç´¢ç”¨æˆ·', 'info');
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';

        setTimeout(() => {
            messageEl.style.display = 'none';
        }, type === 'success' ? 3000 : 5000);
    }
</script>
</body>
</html>