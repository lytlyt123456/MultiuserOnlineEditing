<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œå° - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/dashboard-style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>åä½œç¼–è¾‘ç³»ç»Ÿ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">æ¬¢è¿ï¼Œç”¨æˆ·</span>

                    <!-- æ–°å¢ï¼šé€šçŸ¥å’Œä»»åŠ¡å…¥å£ -->
                    <div class="dashboard-toolbar">
                        <button class="dashboard-btn" onclick="toggleNotificationPanel()" id="notificationBtn">
                            ğŸ”” é€šçŸ¥ <span id="unreadCountBadge" class="badge" style="display: none;">0</span>
                        </button>
                        <button class="dashboard-btn" onclick="toggleDashboardTaskPanel()" id="dashboardTaskBtn">
                            ğŸ“‹ æˆ‘çš„ä»»åŠ¡ <span id="taskCountBadge" class="badge" style="display: none;">0</span>
                        </button>
                    </div>

                    <button onclick="logout()" class="btn">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="card">
                <h3>ä¸ªäººä¿¡æ¯</h3>
                <div id="userProfile">
                    <p>ç”¨æˆ·å: <span id="profileUsername">åŠ è½½ä¸­...</span></p>
                    <p>é‚®ç®±: <span id="profileEmail">åŠ è½½ä¸­...</span></p>
                    <p>æ‰‹æœºå·: <span id="profilePhone">åŠ è½½ä¸­...</span></p>
                    <p>è§’è‰²: <span id="profileRole">åŠ è½½ä¸­...</span></p>
                    <p>å§“å: <span id="profileFullName">æœªè®¾ç½®</span></p>
                    <p>ä¸ªäººç®€ä»‹: <span id="profileBio">æœªè®¾ç½®</span></p>
                </div>
                <div class="action-buttons">
                    <a href="edit-profile.html" class="btn btn-primary">ç¼–è¾‘èµ„æ–™</a>
                </div>
            </div>

            <!-- ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥å…¥å£ -->
            <div class="card">
                <h3>ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥</h3>
                <div id="surveySection">
                    <p>åŠ è½½è°ƒæŸ¥èµ„æ ¼ä¿¡æ¯...</p>
                </div>
                <div id="surveyActions" style="display: none;">
                    <!-- èµ„æ ¼æ£€æŸ¥é€šè¿‡åæ˜¾ç¤º -->
                </div>
            </div>

            <div class="card">
                <h3>æœ€è¿‘æ“ä½œ</h3>
                <div id="recentActivities">
                    <p>æ“ä½œæ—¥å¿—</p>
                </div>
                <div class="action-buttons" style="margin-top: 1rem;">
                    <a href="get-logs.html" class="btn btn-primary">æŸ¥çœ‹å®Œæ•´æ“ä½œæ—¥å¿—</a>
                </div>
            </div>

            <div class="card" id="adminSection" style="display: none;">
                <h3>ç®¡ç†å‘˜åŠŸèƒ½</h3>
                <div class="action-buttons">
                    <a href="get-all-logs.html" class="btn btn-primary">æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·æ—¥å¿—</a>
                    <a href="change-user-role.html" class="btn btn-primary">ç”¨æˆ·è§’è‰²ç®¡ç†</a>
                    <a href="get-user-profiles.html" class="btn btn-primary">ç”¨æˆ·ç®¡ç†</a>

                    <!-- é—®å·ç®¡ç†åŠŸèƒ½ -->
                    <a href="search-surveys-admin.html" class="btn btn-primary">é—®å·é«˜çº§æœç´¢</a>
                    <a href="get-survey-score-distribution.html" class="btn btn-primary">é—®å·è¯„åˆ†åˆ†å¸ƒ</a>
                </div>
            </div>

            <!-- å¯¹äºVIEWERç”¨æˆ·æ˜¾ç¤ºå‡çº§ç”³è¯·å…¥å£ -->
            <div class="card" id="viewerUpgradeSection" style="display: none;">
                <h3>è§’è‰²å‡çº§</h3>
                <p>æ‚¨å½“å‰æ˜¯æŸ¥çœ‹è€…è§’è‰²ï¼Œå¯ä»¥ç”³è¯·å‡çº§ä¸ºç¼–è¾‘è€…ä»¥è·å¾—æ›´å¤šæƒé™ã€‚</p>
                <div class="action-buttons">
                    <a href="change-my-role.html" class="btn btn-primary">ç”³è¯·å‡çº§è§’è‰²</a>
                </div>
            </div>

            <!-- æ–‡æ¡£ç®¡ç†å…¥å£ -->
            <div class="card">
                <h3>æ–‡æ¡£ç®¡ç†</h3>
                <div class="action-buttons">
                    <a href="my-documents.html" class="btn btn-primary">æˆ‘çš„æ–‡æ¡£</a>
                    <a href="search-my-documents.html" class="btn btn-primary">æœç´¢æˆ‘çš„æ–‡æ¡£</a>
                    <a href="search-collaborate-documents.html" class="btn btn-primary">æœç´¢åä½œçš„æ–‡æ¡£</a>
                    <a href="search-documents-ai.html" class="btn btn-primary">æ™ºèƒ½æœç´¢æ–‡æ¡£</a>
                    <a href="documents-classification-ai.html" class="btn btn-primary">æ–‡æ¡£æ™ºèƒ½å½’ç±»</a>
                    <a href="my-tags.html" class="btn btn-primary">æˆ‘çš„æ–‡æ¡£æ ‡ç­¾</a>
                    <a href="my-templates.html" class="btn btn-primary">æˆ‘çš„æ¨¡æ¿</a>
                    <a href="recycle-bin.html" class="btn btn-primary">å›æ”¶ç«™</a>
                </div>
            </div>

        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script src="js/collaboration.js"></script>
<script src="js/managers/dashboard-tasks.js"></script>
<script src="js/managers/notification.js"></script>
<script src="js/survey.js"></script>

<!-- æ–°å¢ï¼šå¼•å…¥WebSocketç›¸å…³åº“ -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script>
    // æ–°å¢ï¼šåä½œç®¡ç†å™¨
    let notificationManager = null;
    let dashboardTaskManager = null;

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½ç”¨æˆ·ä¿¡æ¯
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            return;
        }

        collaborationSocket.connect();

        loadUserInfo();

        // æ–°å¢ï¼šåˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨
        initializeDashboardNotificationManager();

        // æ–°å¢ï¼šåˆå§‹åŒ–ä»»åŠ¡ç®¡ç†å™¨
        initializeDashboardTaskManager();

        // æ–°å¢ï¼šæ£€æŸ¥è°ƒæŸ¥èµ„æ ¼
        checkSurveyEligibility();
    });

    // æ–°å¢ï¼šæ£€æŸ¥è°ƒæŸ¥èµ„æ ¼
    async function checkSurveyEligibility() {
        try {
            const response = await surveyAPI.checkEligibility();
            if (response.success) {
                updateSurveySection(response.data);
            } else {
                document.getElementById('surveySection').innerHTML =
                    '<p class="survey-message">æ— æ³•æ£€æŸ¥è°ƒæŸ¥èµ„æ ¼: ' + response.message + '</p>';
            }
        } catch (error) {
            console.error('æ£€æŸ¥è°ƒæŸ¥èµ„æ ¼é”™è¯¯:', error);
            document.getElementById('surveySection').innerHTML =
                '<p class="survey-message">æ£€æŸ¥è°ƒæŸ¥èµ„æ ¼æ—¶å‘ç”Ÿé”™è¯¯</p>';
        }
    }

    // æ–°å¢ï¼šæ›´æ–°è°ƒæŸ¥éƒ¨åˆ†æ˜¾ç¤º
    function updateSurveySection(data) {
        const surveySection = document.getElementById('surveySection');
        const surveyActions = document.getElementById('surveyActions');

        if (data.eligible) {
            // ç”¨æˆ·æœ‰èµ„æ ¼å¡«å†™é—®å·
            surveySection.innerHTML = `
                <p class="survey-message">
                    âœ… æ‚¨æœ‰èµ„æ ¼å¡«å†™ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥é—®å·
                    <span class="survey-status status-eligible">æœ‰èµ„æ ¼</span>
                </p>
                <p class="survey-message">
                    è¦æ±‚ï¼šç¼–è¾‘è€…è§’è‰²ä¸”æ“ä½œæ—¥å¿—ä¸å°‘äº100æ¡
                </p>
            `;

            surveyActions.innerHTML = `
                <div class="survey-buttons">
                    <a href="answer-survey.html" class="btn-survey">å¡«å†™é—®å·</a>
                </div>
            `;
            surveyActions.style.display = 'block';
        } else {
            // ç”¨æˆ·æ²¡æœ‰èµ„æ ¼
            surveySection.innerHTML = `
                <p class="survey-message">
                    âŒ æ‚¨å½“å‰æ²¡æœ‰èµ„æ ¼å¡«å†™ç”¨æˆ·æ»¡æ„åº¦è°ƒæŸ¥é—®å·
                    <span class="survey-status status-not-eligible">æ— èµ„æ ¼</span>
                </p>
                <p class="survey-message">
                    è¦æ±‚ï¼šå¿…é¡»æ˜¯ç¼–è¾‘è€…è§’è‰²ä¸”æ“ä½œæ—¥å¿—ä¸å°‘äº100æ¡
                </p>
            `;
            surveyActions.style.display = 'none';
        }
    }

    // åˆå§‹åŒ–Dashboardé€šçŸ¥ç®¡ç†å™¨
    async function initializeDashboardNotificationManager() {
        const response = await user.getProfile();
        const currentUserId = response.data.userId;

        collaborationSocket.subscribe(`/topic/user/${currentUserId}/queue/notifications`, (message) => {
            notificationManager.handleNewNotification(message);
        });

        notificationManager = new NotificationManager();
        await notificationManager.initialize();

        window.notificationManager = notificationManager;
    }

    // åˆå§‹åŒ–Dashboardä»»åŠ¡ç®¡ç†å™¨
    async function initializeDashboardTaskManager() {
        dashboardTaskManager = new DashboardTaskManager();
        await dashboardTaskManager.initialize();

        // è®¾ç½®å…¨å±€å¼•ç”¨
        window.dashboardTaskManager = dashboardTaskManager;
    }

    // åˆ‡æ¢Dashboardé€šçŸ¥é¢æ¿
    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        if (panel) {
            panel.classList.toggle('active');
        }
    }

    async function markAsRead(notificationId) {
        if (notificationManager) {
            await notificationManager.markAsRead(notificationId);
        }
    }

    async function markAllAsRead() {
        if (notificationManager) {
            await notificationManager.markAllAsRead();
        }
    }

    async function deleteNotification(notificationId) {
        if (notificationManager) {
            await notificationManager.deleteNotification(notificationId);
        }
    }

    function checkAdminPermission(userData) { // å¦‚æœç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™ï¼Œå°±ä¸æ˜¾ç¤ºadminSectionå¡ç‰‡
        const adminSection = document.getElementById('adminSection');
        if (userData.role === 'ROLE_ADMIN' || userData.role === 'ADMIN') {
            adminSection.style.display = 'block';
        } else {
            adminSection.style.display = 'none';
        }
    }

    // åœ¨loadUserInfoå‡½æ•°ä¸­æ£€æŸ¥è§’è‰²å¹¶æ˜¾ç¤ºç›¸åº”å…¥å£
    function checkRoleSections(userData) {
        const viewerSection = document.getElementById('viewerUpgradeSection');
        if (userData.role === 'VIEWER' || userData.role === 'ROLE_VIEWER') {
            viewerSection.style.display = 'block';
        } else {
            viewerSection.style.display = 'none';
        }
    }

    async function loadUserInfo() {
        try {
            // å…ˆä»æœ¬åœ°å­˜å‚¨æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼ˆå¿«é€Ÿæ˜¾ç¤ºï¼‰
            const localUserData = JSON.parse(localStorage.getItem('user') || '{}');
            if (localUserData.username) {
                document.getElementById('userWelcome').textContent = `æ¬¢è¿ï¼Œ${localUserData.username}`;
                document.getElementById('profileUsername').textContent = localUserData.username;
                document.getElementById('profileEmail').textContent = localUserData.email || 'æœªè®¾ç½®';
                document.getElementById('profileRole').textContent = localUserData.role ? localUserData.role.replace('ROLE_', '') : 'æŸ¥çœ‹è€…';
            }

            // ä»APIè·å–å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
            const response = await user.getProfile();
            console.log('è·å–ç”¨æˆ·èµ„æ–™å“åº”:', response);

            if (response.success && response.data) {
                const userData = response.data;

                // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·æ•°æ®
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                const updatedUser = {
                    ...currentUser,
                    ...userData
                };
                localStorage.setItem('user', JSON.stringify(updatedUser));

                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                document.getElementById('userWelcome').textContent = `æ¬¢è¿ï¼Œ${userData.username}`;
                document.getElementById('profileUsername').textContent = userData.username;
                document.getElementById('profileEmail').textContent = userData.email || 'æœªè®¾ç½®';
                document.getElementById('profileRole').textContent = userData.role ? userData.role.replace('ROLE_', '') : 'VIEWER';
                document.getElementById('profileFullName').textContent = userData.full_name || 'æœªè®¾ç½®';
                document.getElementById('profilePhone').textContent = userData.phone || 'æœªè®¾ç½®';
                document.getElementById('profileBio').textContent = userData.biography || 'æœªè®¾ç½®';
                checkAdminPermission(userData);
                checkRoleSections(userData);

                console.log('ç”¨æˆ·èµ„æ–™æ›´æ–°å®Œæˆ:', userData);
            } else {
                console.error('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', response.message);
                showErrorMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (response.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
            }
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸:', error);
            showErrorMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);

            // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œè‡³å°‘æ˜¾ç¤ºæœ¬åœ°å­˜å‚¨çš„åŸºæœ¬ä¿¡æ¯
            const localUserData = JSON.parse(localStorage.getItem('user') || '{}');
            if (localUserData.username) {
                document.getElementById('profileFullName').textContent = 'åŠ è½½å¤±è´¥';
                document.getElementById('profilePhone').textContent = 'åŠ è½½å¤±è´¥';
                document.getElementById('profileBio').textContent = 'åŠ è½½å¤±è´¥';
            }
        }
    }

    // æ·»åŠ é”™è¯¯æ˜¾ç¤ºå‡½æ•°
    function showErrorMessage(message) {
        // å¯ä»¥åœ¨é¡µé¢ä¸Šæ·»åŠ ä¸€ä¸ªé”™è¯¯æç¤ºåŒºåŸŸï¼Œæˆ–è€…ä½¿ç”¨console.log
        console.error('ç”¨æˆ·ä¿¡æ¯åŠ è½½é”™è¯¯:', message);

        // åœ¨é¡µé¢ä¸Šæ˜¾ç¤ºé”™è¯¯æç¤º
        const errorDiv = document.getElementById('errorMessage') || createErrorMessageElement();
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';

        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }

    // åˆ›å»ºé”™è¯¯æ¶ˆæ¯å…ƒç´ ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    function createErrorMessageElement() {
        const errorDiv = document.createElement('div');
        errorDiv.id = 'errorMessage';
        errorDiv.className = 'message error';
        errorDiv.style.position = 'fixed';
        errorDiv.style.top = '20px';
        errorDiv.style.right = '20px';
        errorDiv.style.zIndex = '1000';
        errorDiv.style.display = 'none';
        document.body.appendChild(errorDiv);
        return errorDiv;
    }

</script>
</body>
</html>