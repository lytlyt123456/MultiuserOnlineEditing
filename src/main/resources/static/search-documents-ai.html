<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIæ™ºèƒ½æœç´¢ - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/search-documents-ai-style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>AIæ™ºèƒ½æœç´¢ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">æ¬¢è¿</span>
                    <button onclick="goBack()" class="btn">è¿”å›</button>
                    <button onclick="logout()" class="btn">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="search-container">
                <div class="search-header">
                    <h2>AIæ™ºèƒ½æ–‡æ¡£æœç´¢</h2>
                    <p>åŸºäºå†…å®¹ç†è§£çš„ç›¸å…³åº¦æœç´¢ï¼Œæ‰¾åˆ°æœ€åŒ¹é…çš„æ–‡æ¡£</p>
                </div>

                <div class="search-box">
                    <div class="search-input-group">
                        <input type="text" id="searchInput" class="search-input"
                               placeholder="è¯·è¾“å…¥æœç´¢å†…å®¹..."
                               onkeypress="handleKeyPress(event)">
                        <button id="searchBtn" class="search-btn" onclick="performSearch()">æœç´¢</button>
                    </div>
                    <div class="search-tips">
                        ğŸ’¡ æç¤ºï¼šå¯ä»¥è¾“å…¥å®Œæ•´çš„é—®é¢˜æè¿°ï¼ŒAIä¼šç†è§£æ‚¨çš„æœç´¢æ„å›¾
                    </div>
                </div>

                <div id="resultsArea" style="display: none;">
                    <div class="results-container">
                        <div class="results-header">
                            <h3>æœç´¢ç»“æœ</h3>
                            <div class="results-count" id="resultsCount">æ‰¾åˆ° 0 ä¸ªæ–‡æ¡£</div>
                        </div>
                        <div class="results-list" id="resultsList">
                            <!-- æœç´¢ç»“æœå°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script src="js/document.js"></script>

<script>
    let currentSearchTerm = '';
    let isLoading = false;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            return;
        }

        // èšç„¦æœç´¢æ¡†
        document.getElementById('searchInput').focus();
    });

    // å¤„ç†é”®ç›˜äº‹ä»¶
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            performSearch();
        }
    }

    // æ‰§è¡Œæœç´¢
    async function performSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchTerm = searchInput.value.trim();

        if (!searchTerm) {
            alert('è¯·è¾“å…¥æœç´¢å†…å®¹');
            return;
        }

        if (isLoading) return;

        // è®¾ç½®åŠ è½½çŠ¶æ€
        isLoading = true;
        searchBtn.disabled = true;
        searchBtn.textContent = 'æœç´¢ä¸­...';
        currentSearchTerm = searchTerm;

        try {
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            showLoading();

            // è°ƒç”¨AIæœç´¢API
            const response = await documentAPI.aiSearch(searchTerm);

            if (response.success) {
                displaySearchResults(response.data.documents);
            } else {
                showError('æœç´¢å¤±è´¥: ' + response.message);
            }
        } catch (error) {
            console.error('æœç´¢é”™è¯¯:', error);
            showError('æœç´¢å¤±è´¥: ' + error.message);
        } finally {
            // æ¢å¤æŒ‰é’®çŠ¶æ€
            isLoading = false;
            searchBtn.disabled = false;
            searchBtn.textContent = 'æœç´¢';
        }
    }

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    function showLoading() {
        const resultsArea = document.getElementById('resultsArea');
        const resultsList = document.getElementById('resultsList');

        resultsArea.style.display = 'block';
        resultsList.innerHTML = `
            <div class="loading">
                <div>ğŸ” AIæ­£åœ¨æ™ºèƒ½åˆ†ææœç´¢å†…å®¹...</div>
                <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #999;">
                    åŸºäºTF-IDFç®—æ³•è®¡ç®—æ–‡æ¡£ç›¸å…³åº¦
                </div>
            </div>
        `;
        document.getElementById('resultsCount').textContent = 'æœç´¢ä¸­...';
    }

    // æ˜¾ç¤ºæœç´¢ç»“æœ
    function displaySearchResults(documents) {
        const resultsArea = document.getElementById('resultsArea');
        const resultsList = document.getElementById('resultsList');
        const resultsCount = document.getElementById('resultsCount');

        resultsArea.style.display = 'block';

        if (!documents || documents.length === 0) {
            resultsList.innerHTML = `
                <div class="no-results">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ”</div>
                    <div>æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„æ–‡æ¡£</div>
                    <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #999;">
                        å°è¯•ä½¿ç”¨å…¶ä»–å…³é”®è¯æˆ–æ›´è¯¦ç»†çš„æè¿°
                    </div>
                </div>
            `;
            resultsCount.textContent = 'æ‰¾åˆ° 0 ä¸ªæ–‡æ¡£';
            return;
        }

        resultsCount.textContent = `æ‰¾åˆ° ${documents.length} ä¸ªæ–‡æ¡£`;

        let html = '';
        documents.forEach((doc, index) => {
            // æˆªå–å†…å®¹é¢„è§ˆ
            const contentPreview = doc.content ?
                doc.content.replace(/<[^>]+>/g, '').substring(0, 150) + '...' :
                'æ— å†…å®¹';

            // æ ¼å¼åŒ–æ—¶é—´
            const updateTime = new Date(doc.updatedAt).toLocaleString();

            html += `
                <div class="result-item" onclick="openDocument(${doc.id})">
                    <div class="result-title">
                        ${doc.title || 'æœªå‘½åæ–‡æ¡£'}
                        <span class="result-type">${getDocumentTypeText(doc.type)}</span>
                    </div>
                    <div class="result-content">${contentPreview}</div>
                    <div class="result-meta">
                        <span>æ‰€æœ‰è€…: ${doc.owner}</span>
                        <span>æ›´æ–°: ${updateTime}</span>
                        <span>ç‰ˆæœ¬: v${doc.version || 1}</span>
                    </div>
                </div>
            `;
        });

        resultsList.innerHTML = html;
    }

    // è·å–æ–‡æ¡£ç±»å‹æ–‡æœ¬
    function getDocumentTypeText(type) {
        const typeMap = {
            'RICH_TEXT': 'å¯Œæ–‡æœ¬',
            'MARKDOWN': 'Markdown'
        };
        return typeMap[type] || type;
    }

    // æ‰“å¼€æ–‡æ¡£
    function openDocument(documentId) {
        window.location.href = `edit-document.html?id=${documentId}`;
    }

    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
    function showError(message) {
        const resultsArea = document.getElementById('resultsArea');
        const resultsList = document.getElementById('resultsList');

        resultsArea.style.display = 'block';
        resultsList.innerHTML = `
            <div class="error-message">
                ${message}
            </div>
        `;
        document.getElementById('resultsCount').textContent = 'æœç´¢å‡ºé”™';
    }

    // è¿”å›ä¸Šä¸€é¡µ
    function goBack() {
        window.history.back();
    }
</script>
</body>
</html>