<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新建模板 - 协作编辑系统</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/create-template-style.css">
    <!-- 引入Quill富文本编辑器 -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- 引入Markdown编辑器样式 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>新建模板 ·</h1>
                <div class="user-info">
                    <span id="userWelcome">欢迎</span>
                    <a href="my-templates.html" class="btn">返回模板列表</a>
                    <button onclick="logout()" class="btn">退出登录</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="form-container">
                <form id="createTemplateForm" onsubmit="return false;">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="name">模板名称 *</label>
                            <input type="text" id="name" placeholder="请输入模板名称" required maxlength="100">
                            <div class="form-help">模板名称不能超过100个字符</div>
                            <div class="character-count">
                                <span id="nameCount">0</span>/100
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="category">模板分类 *</label>
                            <select id="category" required>
                                <option value="">请选择分类</option>
                                <option value="BUSINESS">商务</option>
                                <option value="TECHNICAL">技术</option>
                                <option value="ACADEMIC">学术</option>
                                <option value="PERSONAL">个人</option>
                                <option value="MEETING">会议</option>
                                <option value="REPORT">报告</option>
                                <option value="PROPOSAL">提案</option>
                                <option value="OTHER">其他</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">模板描述</label>
                        <textarea id="description" placeholder="请输入模板描述（可选）" maxlength="500"></textarea>
                        <div class="form-help">模板描述不能超过500个字符</div>
                        <div class="character-count">
                            <span id="descriptionCount">0</span>/500
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="documentType">文档类型 *</label>
                        <select id="documentType" required onchange="onDocumentTypeChange()">
                            <option value="">请选择文档类型</option>
                            <option value="RICH_TEXT">富文本</option>
                            <option value="MARKDOWN">Markdown</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>模板内容 *</label>

                        <div class="editor-content">
                            <!-- 富文本编辑器 -->
                            <div class="editor-panel active" id="richTextPanel">
                                <div id="richTextEditor"></div>
                            </div>

                            <!-- Markdown编辑器 -->
                            <div class="editor-panel" id="markdownPanel">
                                <div class="split-layout">
                                    <div>
                                        <label style="font-size: 0.9rem; color: #666;">编辑区</label>
                                        <textarea id="markdownEditor" placeholder="请输入Markdown内容..."></textarea>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.9rem; color: #666;">预览区</label>
                                        <div id="markdownPreview" class="markdown-preview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="isPublic">
                            <label for="isPublic">设为公开模板</label>
                        </div>
                        <div class="form-help">公开模板可以被其他用户使用</div>
                    </div>

                    <div class="action-buttons">
                        <button type="button" onclick="createTemplate()" class="btn btn-primary">创建模板</button>
                        <button type="button" onclick="goBack()" class="btn btn-outline">取消</button>
                    </div>
                </form>
            </div>
        </div>
    </main>
</div>

<!-- 引入Quill富文本编辑器 -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- 引入Markdown编辑器 -->
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<!-- 引入Marked用于Markdown预览 -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script src="js/document.js"></script>
<script>
    let quill = null;
    let easyMDE = null;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            return;
        }

        initializeEditors();
        setupCharacterCounters();
    });

    // 初始化编辑器
    function initializeEditors() {
        // 初始化富文本编辑器
        quill = new Quill('#richTextEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: '请输入模板内容...'
        });

        // 初始化Markdown编辑器
        easyMDE = new EasyMDE({
            element: document.getElementById('markdownEditor'),
            spellChecker: false,
            autosave: {
                enabled: false
            },
            placeholder: '请输入Markdown内容...',
            toolbar: [
                'bold', 'italic', 'heading', '|',
                'code', 'quote', 'unordered-list', 'ordered-list', '|',
                'link', 'image', '|',
                'preview', 'side-by-side', 'fullscreen', '|',
                'guide'
            ]
        });

        // 监听Markdown内容变化，更新预览
        easyMDE.codemirror.on('change', function() {
            updateMarkdownPreview();
        });
    }

    // 文档类型变更处理
    function onDocumentTypeChange() {
        const documentType = document.getElementById('documentType').value;
        if (documentType === 'RICH_TEXT') {
            switchToEditor('richText');
        } else if (documentType === 'MARKDOWN') {
            switchToEditor('markdown');
        }
    }

    // 切换编辑器
    function switchToEditor(editorType) {
        // 更新面板状态
        document.querySelectorAll('.editor-panel').forEach(panel => {
            panel.classList.remove('active');
        });
        document.getElementById(`${editorType}Panel`).classList.add('active');

        // 更新文档类型选择
        document.getElementById('documentType').value = editorType === 'richText' ? 'RICH_TEXT' : 'MARKDOWN';
    }

    // 更新Markdown预览
    function updateMarkdownPreview() {
        const content = easyMDE.value();
        const preview = document.getElementById('markdownPreview');
        preview.innerHTML = marked.parse(content || '');
    }

    // 设置字符计数器
    function setupCharacterCounters() {
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const nameCount = document.getElementById('nameCount');
        const descriptionCount = document.getElementById('descriptionCount');

        nameInput.addEventListener('input', function() {
            nameCount.textContent = this.value.length;
        });

        descriptionInput.addEventListener('input', function() {
            descriptionCount.textContent = this.value.length;
        });

        // 初始化计数
        nameCount.textContent = nameInput.value.length;
        descriptionCount.textContent = descriptionInput.value.length;
    }

    // 创建模板
    async function createTemplate() {
        const name = document.getElementById('name').value.trim();
        const description = document.getElementById('description').value.trim();
        const category = document.getElementById('category').value;
        const documentType = document.getElementById('documentType').value;
        const isPublic = document.getElementById('isPublic').checked;

        if (!name) {
            alert('请输入模板名称');
            return;
        }

        if (!category) {
            alert('请选择模板分类');
            return;
        }

        if (!documentType) {
            alert('请选择文档类型');
            return;
        }

        let content = '';
        if (documentType === 'RICH_TEXT') {
            content = quill.root.innerHTML;
        } else if (documentType === 'MARKDOWN') {
            content = easyMDE.value();
        }

        if (!content) {
            alert('请输入模板内容');
            return;
        }

        if (name.length > 100) {
            alert('模板名称不能超过100个字符');
            return;
        }

        if (description.length > 500) {
            alert('模板描述不能超过500个字符');
            return;
        }

        try {
            const templateData = {
                name: name,
                description: description || '',
                content: content,
                category: category,
                isPublic: isPublic,
                documentType: documentType
            };

            const response = await templateAPI.createTemplate(templateData);

            if (response.success) {
                alert('模板创建成功！');
                // 返回到模板列表页面
                window.location.href = 'my-templates.html';
            } else {
                alert('创建失败: ' + response.message);
            }
        } catch (error) {
            console.error('创建模板错误:', error);
            alert('创建失败: ' + error.message);
        }
    }

    // 返回上一页
    function goBack() {
        window.history.back();
    }
</script>
</body>
</html>