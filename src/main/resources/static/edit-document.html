<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘æ–‡æ¡£ - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/edit-document-style.css">
    <!-- å¼•å…¥Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <!-- å¼•å…¥Markdownç¼–è¾‘å™¨æ ·å¼ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>ç¼–è¾‘æ–‡æ¡£ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">æ¬¢è¿</span>

                    <!-- æ–°å¢ï¼šåä½œå·¥å…·æ  -->
                    <div class="collaboration-toolbar">
                        <div class="online-users" id="onlineUsers">
                            <!-- åœ¨çº¿ç”¨æˆ·å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                        </div>

                        <!-- æ–°å¢ï¼šè§†é¢‘ä¼šè®® -->
                        <button class="collaboration-btn" onclick="toggleVideoConferencePanel()" id="videoConferenceBtn">
                            ğŸ“¹ è§†é¢‘ä¼šè®®
                        </button>

                        <button class="collaboration-btn" onclick="toggleCommentSidebar()" id="commentBtn">
                            ğŸ’¬ è¯„è®º
                        </button>
                        <button class="collaboration-btn" onclick="toggleTaskSidebar()" id="taskBtn">
                            ğŸ“‹ ä»»åŠ¡
                        </button>
                        <button class="collaboration-btn" onclick="toggleNotificationPanel()" id="notificationBtn">
                            ğŸ”” é€šçŸ¥ <span id="unreadCountBadge" class="badge" style="display: none;">0</span>
                        </button>
                    </div>

                    <button onclick="goBack()" class="btn">è¿”å›æ–‡æ¡£åˆ—è¡¨</button>
                    <button onclick="logout()" class="btn">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="editor-container">
                <!-- æ–‡æ¡£åŸºæœ¬ä¿¡æ¯ -->
                <div class="document-info" id="documentInfo">
                    <div class="document-info-item">
                        <strong>åˆ›å»ºæ—¶é—´:</strong> <span id="createdAt">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="document-info-item">
                        <strong>æœ€åæ›´æ–°:</strong> <span id="updatedAt">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="document-info-item">
                        <strong>æ–‡æ¡£çŠ¶æ€:</strong> <span id="documentStatus">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="document-info-item">
                        <strong>å½“å‰ç‰ˆæœ¬:</strong> <span id="documentVersion">åŠ è½½ä¸­...</span>
                    </div>
                    <div class="document-info-item">
                        <strong>æ–‡æ¡£æ‰€æœ‰è€…:</strong> <span id="documentOwner">åŠ è½½ä¸­...</span>
                    </div>
                </div>

                <form id="editDocumentForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="title">æ–‡æ¡£æ ‡é¢˜ *</label>
                        <input type="text" id="title" placeholder="è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜" required maxlength="200">
                        <div class="form-help">æ–‡æ¡£æ ‡é¢˜ä¸èƒ½è¶…è¿‡200ä¸ªå­—ç¬¦</div>
                        <div class="character-count">
                            <span id="titleCount">0</span>/200
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="editor-header">
                            <label>æ–‡æ¡£å†…å®¹ *</label>
                            <span class="editor-type-badge" id="editorTypeBadge">åŠ è½½ä¸­...</span>
                        </div>

                        <div class="editor-content">
                            <!-- å¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
                            <div class="editor-panel" id="richTextPanel">
                                <div id="richTextEditor"></div>
                            </div>

                            <!-- Markdownç¼–è¾‘å™¨ -->
                            <div class="editor-panel" id="markdownPanel">
                                <div class="split-layout">
                                    <div>
                                        <label style="font-size: 0.9rem; color: #666;">ç¼–è¾‘åŒº</label>
                                        <textarea id="markdownEditor" placeholder="è¯·è¾“å…¥Markdownå†…å®¹..."></textarea>
                                    </div>
                                    <div>
                                        <label style="font-size: 0.9rem; color: #666;">é¢„è§ˆåŒº</label>
                                        <div id="markdownPreview" class="markdown-preview"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éšè—çš„æ–‡æ¡£IDå­—æ®µ -->
                    <input type="hidden" id="documentId">

                    <div class="action-buttons">
                        <button type="button" onclick="saveDocument()" class="btn btn-primary">ä¿å­˜ä¿®æ”¹</button>
                        <button type="button" onclick="goBack()" class="btn btn-outline">å–æ¶ˆ</button>

                        <!-- å¯¼å‡ºæ–‡æ¡£ -->
                        <button type="button" onclick="showExportOptions()" class="btn btn-secondary">å¯¼å‡ºæ–‡æ¡£</button>
                    </div>
                </form>

                <!-- åä½œè€…ç®¡ç† -->
                <div class="collaborators-section" id="collaboratorsSection" style="display: none;">
                    <h3>åä½œè€…ç®¡ç†</h3>
                    <div class="collaborators-list" id="collaboratorsList">
                        <!-- åä½œè€…åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                    <div class="add-collaborator-form">
                        <input type="text" id="collaboratorUsername" placeholder="è¾“å…¥ç”¨æˆ·åæ·»åŠ åä½œè€…">
                        <button type="button" onclick="addCollaborator()" class="btn btn-primary">æ·»åŠ åä½œè€…</button>
                    </div>
                </div>

                <div id="exportModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>å¯¼å‡ºæ–‡æ¡£</h3>
                            <span class="close" onclick="closeExportModal()">&times;</span>
                        </div>
                        <div class="modal-body">
                            <div id="exportOptions">
                                <!-- å¯¼å‡ºé€‰é¡¹å°†æ ¹æ®æ–‡æ¡£ç±»å‹åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å±é™©æ“ä½œåŒºåŸŸ -->
                <div class="danger-zone">
                    <h3>å±é™©æ“ä½œ</h3>
                    <p>åˆ é™¤æ–‡æ¡£å°†æŠŠæ–‡æ¡£ç§»åˆ°å›æ”¶ç«™ã€‚æ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
                    <button type="button" onclick="deleteDocument()" class="btn btn-delete">åˆ é™¤æ–‡æ¡£</button>
                </div>

                <!-- çŠ¶æ€æ  -->
                <div class="status-bar">
                    <div class="auto-save-status">
                        <span class="save-indicator" id="saveIndicator">âœ“ å·²ä¿å­˜</span>
                        <span class="saving-indicator" id="savingIndicator">æ­£åœ¨ä¿å­˜...</span>
                        <span id="lastSaveTime">æœ€åä¿å­˜: --</span>
                    </div>
                    <div>
                        <span id="changeStatus">æ— æ›´æ”¹</span>
                    </div>
                </div>

                <!-- è§†é¢‘ä¼šè®®é¢æ¿ -->
                <div id="videoConferencePanel" class="video-conference-panel">
                    <div class="conference-header">
                        <h3 id="conferenceTitle">è§†é¢‘ä¼šè®®</h3>
                        <button class="conference-close" onclick="leaveConference()">Ã—</button>
                    </div>

                    <div class="conference-content">
                        <!-- è§†é¢‘åŒºåŸŸ -->
                        <div class="video-container" id="videoContainer">
                            <!-- è§†é¢‘æµå°†åœ¨è¿™é‡ŒåŠ¨æ€æ·»åŠ  -->
                        </div>

                        <!-- ä¾§è¾¹æ  -->
                        <div class="sidebar">
                            <!-- å‚ä¸è€…åˆ—è¡¨ -->
                            <div class="participants-list" id="participantsList">
                                <!-- å‚ä¸è€…åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                            </div>

                            <!-- èŠå¤©åŒºåŸŸ -->
                            <div class="chat-container">
                                <div class="chat-messages" id="chatMessages">
                                    <!-- èŠå¤©æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€æ˜¾ç¤º -->
                                </div>
                                <div class="chat-input">
                                    <form onsubmit="sendChatMessage(event)">
                                        <input type="text" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." maxlength="500">
                                        <button type="submit">å‘é€</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ§åˆ¶æŒ‰é’® -->
                    <div class="conference-controls">
                        <button class="control-button outline" onclick="toggleVideo()" id="videoToggle">
                            ğŸ“¹ å…³é—­è§†é¢‘
                        </button>
                        <button class="control-button outline" onclick="toggleAudio()" id="audioToggle">
                            ğŸ¤ é™éŸ³
                        </button>
                        <button class="control-button outline" onclick="toggleScreenSharing()" id="screenShareToggle">
                            ğŸ–¥ï¸ å…±äº«å±å¹•
                        </button>
                        <button class="control-button danger" onclick="leaveConference()">
                            ğŸšª ç¦»å¼€ä¼šè®®
                        </button>
                        <button class="control-button danger" onclick="endConference()">
                            ğŸ”š ç»“æŸä¼šè®®
                        </button>
                    </div>
                </div>

                <!-- ä¼šè®®ç®¡ç†æ¨¡æ€æ¡† -->
                <div id="conferenceManagementModal" class="modal" style="display: none;">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>è§†é¢‘ä¼šè®®ç®¡ç†</h3>
                            <span class="close" onclick="closeConferenceManagementModal()">&times;</span>
                        </div>
                        <div class="modal-body">
<!--                            <div class="conference-tabs">-->
<!--                                <button class="tab-button active" onclick="switchConferenceTab('create')">åˆ›å»ºä¼šè®®</button>-->
<!--                                <button class="tab-button" onclick="switchConferenceTab('join')">åŠ å…¥ä¼šè®®</button>-->
<!--                            </div>-->

                            <div id="createConferenceTab" class="tab-content active">
                                <div class="create-conference-form">
                                    <div class="form-row">
                                        <label for="conferenceTitleInput">ä¼šè®®æ ‡é¢˜</label>
                                        <input type="text" id="conferenceTitleInput" placeholder="è¯·è¾“å…¥ä¼šè®®æ ‡é¢˜" maxlength="100">
                                    </div>
                                    <div class="form-row">
                                        <label for="conferenceDescription">ä¼šè®®æè¿°</label>
                                        <textarea id="conferenceDescription" placeholder="è¯·è¾“å…¥ä¼šè®®æè¿°ï¼ˆå¯é€‰ï¼‰"></textarea>
                                    </div>
                                    <div class="form-row">
                                        <label for="maxParticipants">æœ€å¤§å‚ä¸äººæ•°</label>
                                        <input type="number" id="maxParticipants" value="10" min="2" max="20">
                                    </div>
                                    <button class="control-button primary" onclick="createConference()">åˆ›å»ºä¼šè®®</button>
                                </div>
                            </div>

                            <div id="joinConferenceTab" class="tab-content">
                                <div class="conference-list" id="availableConferences">
                                    <!-- å¯ç”¨ä¼šè®®åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                </div>
                                <div class="no-conferences" id="noConferences" style="display: none;">
                                    <p>å½“å‰æ²¡æœ‰å¯ç”¨çš„ä¼šè®®</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </main>
</div>

<!-- å¼•å…¥Quillå¯Œæ–‡æœ¬ç¼–è¾‘å™¨ -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<!-- å¼•å…¥Markdownç¼–è¾‘å™¨ -->
<script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
<!-- å¼•å…¥Markedç”¨äºMarkdowné¢„è§ˆ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- æ–°å¢ï¼šå¼•å…¥WebSocketç›¸å…³åº“ -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script src="js/document.js"></script>
<script src="js/collaboration.js"></script>
<script src="js/managers/collaborations.js"></script>
<script src="js/managers/comments.js"></script>
<script src="js/managers/tasks.js"></script>
<script src="js/managers/notification.js"></script>
<script src="js/video-conference.js"></script>

<script>
    let currentDocumentId = null;
    let quill = null;
    let easyMDE = null;
    let currentDocumentType = '';
    let isChanged = false;
    let lastSaveTime = null;
    let isOwner = false;
    let exportModal = null;

    // åä½œç®¡ç†å™¨å®ä¾‹
    let collaborationManager = null;
    let commentManager = null;
    let taskManager = null;
    let notificationManager = null;

    // æ–°å¢ï¼šè§†é¢‘ä¼šè®®ç®¡ç†å™¨å®ä¾‹ã€è§†é¢‘ä¼šè®®UI
    let videoConferenceManager = null;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            return;
        }

        collaborationSocket.connect();

        // è·å–URLå‚æ•°ä¸­çš„æ–‡æ¡£ID
        const urlParams = new URLSearchParams(window.location.search);
        currentDocumentId = urlParams.get('id');

        if (!currentDocumentId) {
            alert('æ— æ•ˆçš„æ–‡æ¡£ID');
            window.location.href = 'my-documents.html';
            return;
        }

        // è®¾ç½®éšè—å­—æ®µ
        document.getElementById('documentId').value = currentDocumentId;

        // åˆå§‹åŒ–ç¼–è¾‘å™¨
        initializeEditors();
        setupEventListeners();
        setupCharacterCounters();

        // æ–°å¢ï¼šåˆå§‹åŒ–åä½œç®¡ç†å™¨
        initializeCollaborationManagers();

        // åŠ è½½æ–‡æ¡£è¯¦æƒ…
        loadDocumentDetail(currentDocumentId, true);

        exportModal = document.getElementById('exportModal');
    });

    // æ–°å¢ï¼šåˆå§‹åŒ–åä½œç®¡ç†å™¨
    async function initializeCollaborationManagers() {
        // åˆå§‹åŒ–åä½œç®¡ç†å™¨
        collaborationManager = new CollaborationManager();
        await collaborationManager.initialize(currentDocumentId);

        // åˆå§‹åŒ–è¯„è®ºç®¡ç†å™¨
        commentManager = new CommentManager();
        window.commentManager = commentManager; // è®¾ç½®å…¨å±€å¼•ç”¨
        await commentManager.initialize(currentDocumentId);

        // åˆå§‹åŒ–ä»»åŠ¡ç®¡ç†å™¨
        taskManager = new TaskManager();
        window.taskManager = taskManager;
        await taskManager.initialize(currentDocumentId);

        // åˆå§‹åŒ–é€šçŸ¥ç®¡ç†å™¨
        notificationManager = new NotificationManager();
        window.notificationManager = notificationManager;
        await notificationManager.initialize();

        // åˆå§‹åŒ–è§†é¢‘ä¼šè®®ç®¡ç†å™¨
        videoConferenceManager = new VideoConferenceManager();
        window.videoConferenceManager = videoConferenceManager;
        await videoConferenceManager.initialize(currentDocumentId);
    }

    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    function initializeEditors() {
        // åˆå§‹åŒ–å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        quill = new Quill('#richTextEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link', 'image'],
                    ['clean']
                ]
            },
            placeholder: 'è¯·è¾“å…¥æ–‡æ¡£å†…å®¹...'
        });

        // åˆå§‹åŒ–Markdownç¼–è¾‘å™¨
        easyMDE = new EasyMDE({
            element: document.getElementById('markdownEditor'),
            spellChecker: false,
            autosave: {
                enabled: false
            },
            placeholder: 'è¯·è¾“å…¥Markdownå†…å®¹...',
            toolbar: [
                'bold', 'italic', 'heading', '|',
                'code', 'quote', 'unordered-list', 'ordered-list', '|',
                'link', 'image', '|',
                'preview', 'side-by-side', 'fullscreen', '|',
                'guide'
            ]
        });

        // æ–°å¢ï¼šè®¾ç½®å…¨å±€å¼•ç”¨
        window.quill = quill;
        window.easyMDE = easyMDE;
        window.currentDocumentType = currentDocumentType;
    }

    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    function setupEventListeners() {
        // å¯Œæ–‡æœ¬ç¼–è¾‘å™¨å˜åŒ–ç›‘å¬
        // åœ¨åˆå§‹åŒ–çš„æ—¶å€™å°±ä¼šè§¦å‘ä¸€æ¬¡text-changeï¼Œæ‰€ä»¥åº”å½“è®¾ç½®å»¶è¿Ÿ
        setTimeout(() => {
            quill.on('text-change', function(delta, oldDelta, source) {
                if (source === 'user') {
                    markAsChanged();

                    // å‘é€å†…å®¹æ›´æ–°åˆ°å…¶ä»–åä½œè€…
                    if (collaborationManager) {
                        const content = quill.root.innerHTML;
                        collaborationManager.sendContentUpdate(content);
                    }
                }
            });

            // ç›‘å¬å…‰æ ‡æ´»åŠ¨
            quill.on('selection-change', (range, oldRange, source) => {
                if (range && source === 'user' && collaborationManager) {
                    const position = collaborationManager.calculateQuillCursorPosition(range);
                    collaborationManager.sendCursorUpdate(position);
                }
            });
        }, 100);

        // Markdownç¼–è¾‘å™¨å˜åŒ–ç›‘å¬
        setTimeout(() => {
            easyMDE.codemirror.on('change', () => {
                    updateMarkdownPreview();
                    markAsChanged();

                    // å‘é€å†…å®¹æ›´æ–°åˆ°å…¶ä»–åä½œè€…
                    if (collaborationManager) {
                        const content = easyMDE.value();
                        collaborationManager.sendContentUpdate(content);
                    }
            });

            // ç›‘å¬å…‰æ ‡æ´»åŠ¨
            easyMDE.codemirror.on('cursorActivity', () => {
                if (collaborationManager) {
                    const cursor = easyMDE.codemirror.getCursor();
                    const position = easyMDE.codemirror.indexFromPos(cursor);
                    collaborationManager.sendCursorUpdate(position);
                }
            });
        }, 100);
    }

    // è®¾ç½®å­—ç¬¦è®¡æ•°å™¨
    function setupCharacterCounters() {
        const titleInput = document.getElementById('title');
        const titleCount = document.getElementById('titleCount');

        titleInput.addEventListener('input', function() {
            titleCount.textContent = this.value.length;
        });

        // åˆå§‹åŒ–è®¡æ•°
        titleCount.textContent = titleInput.value.length;
    }

    // æ›´æ–°Markdowné¢„è§ˆ
    function updateMarkdownPreview() {
        const content = easyMDE.value();
        const preview = document.getElementById('markdownPreview');
        preview.innerHTML = marked.parse(content || '');
    }

    // æ ‡è®°ä¸ºå·²æ›´æ”¹
    function markAsChanged() {
        if (!isChanged) {
            isChanged = true;
            document.getElementById('changeStatus').textContent = 'æœ‰æœªä¿å­˜çš„æ›´æ”¹';
            document.getElementById('changeStatus').style.color = '#dc3545';
        }
        autoSaveDocument();
    }

    // è‡ªåŠ¨ä¿å­˜æ–‡æ¡£
    async function autoSaveDocument() {
        if (!isChanged || !currentDocumentId) {
            return;
        }

        try {
            const content = getCurrentContent();
            if (!content) {
                return;
            }

            // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
            document.getElementById('savingIndicator').style.display = 'inline';

            await documentAPI.autoSaveDocument(currentDocumentId, content);

            // æ›´æ–°æœ€åä¿å­˜æ—¶é—´
            lastSaveTime = new Date();
            document.getElementById('lastSaveTime').textContent = `æœ€åä¿å­˜: ${lastSaveTime.toLocaleTimeString()}`;

            // éšè—ä¿å­˜ä¸­çŠ¶æ€
            document.getElementById('savingIndicator').style.display = 'none';

        } catch (error) {
            console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', error);
            document.getElementById('savingIndicator').style.display = 'none';
        }
    }

    // è·å–å½“å‰å†…å®¹
    function getCurrentContent() {
        if (currentDocumentType === 'RICH_TEXT') {
            return quill.root.innerHTML;
        } else if (currentDocumentType === 'MARKDOWN') {
            return easyMDE.value();
        }
        return '';
    }

    // åŠ è½½æ–‡æ¡£è¯¦æƒ…
    async function loadDocumentDetail(documentId, restore = false) {
        try {
            const response = await documentAPI.getDocumentDetail(documentId);
            if (response.success) {
                const documentData = response.data; // è¿™é‡Œåº”è¯¥æ˜¯ response.data
                await populateForm(documentData, restore);
            } else {
                alert('åŠ è½½æ–‡æ¡£è¯¦æƒ…å¤±è´¥: ' + response.message);
                window.location.href = 'my-documents.html';
            }
        } catch (error) {
            console.error('åŠ è½½æ–‡æ¡£è¯¦æƒ…é”™è¯¯:', error);
            alert('åŠ è½½æ–‡æ¡£è¯¦æƒ…å¤±è´¥: ' + error.message);
            window.location.href = 'my-documents.html';
        }
    }

    // å¡«å……è¡¨å•æ•°æ®
    async function populateForm(documentData, restore) {
        let currentUser = null;
        try {
            // è·å–å½“å‰ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯
            const userResponse = await user.getProfile();
            if (userResponse.success) {
                currentUser = userResponse.data;
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
        }

        // ä¿å­˜æ–‡æ¡£ç±»å‹
        currentDocumentType = documentData.type || '';
        window.currentDocumentType = currentDocumentType;

        // æ£€æŸ¥æ˜¯å¦æœ‰è‡ªåŠ¨ä¿å­˜å†…å®¹
        let contentToLoad = documentData.content || '';

        if (currentUser.role !== 'VIEWER') {
            if (restore === true) {
                if (documentData.autoSaveContent) {
                    const shouldRestore = confirm('æ£€æµ‹åˆ°ä¸Šæ¬¡æœªä¿å­˜çš„å†…å®¹ï¼Œæ˜¯å¦æ¢å¤ï¼Ÿ\nç‚¹å‡»"ç¡®å®š"æ¢å¤æœªä¿å­˜çš„å†…å®¹ï¼Œç‚¹å‡»"å–æ¶ˆ"ä½¿ç”¨å·²ä¿å­˜çš„å†…å®¹ã€‚');
                    if (shouldRestore) {
                        contentToLoad = documentData.autoSaveContent;
                        alert('å·²æ¢å¤ä¸Šæ¬¡æœªä¿å­˜çš„å†…å®¹');
                    }
                }
            }
        }

        // å¡«å……è¡¨å•å­—æ®µ
        document.getElementById('title').value = documentData.title || '';
        document.getElementById('documentId').value = documentData.id || '';

        // æ ¹æ®æ–‡æ¡£ç±»å‹æ˜¾ç¤ºå¯¹åº”çš„ç¼–è¾‘å™¨
        if (currentDocumentType === 'RICH_TEXT') {
            quill.root.innerHTML = contentToLoad;
            document.getElementById('richTextPanel').classList.add('active');
            document.getElementById('editorTypeBadge').textContent = 'å¯Œæ–‡æœ¬';
            document.getElementById('editorTypeBadge').style.background = '#007bff';
        } else if (currentDocumentType === 'MARKDOWN') {
            easyMDE.value(contentToLoad);
            updateMarkdownPreview();
            document.getElementById('markdownPanel').classList.add('active');
            document.getElementById('editorTypeBadge').textContent = 'Markdown';
            document.getElementById('editorTypeBadge').style.background = '#28a745';
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        document.getElementById('titleCount').textContent = documentData.title ? documentData.title.length : 0;

        // æ›´æ–°æ–‡æ¡£ä¿¡æ¯æ˜¾ç¤º
        document.getElementById('createdAt').textContent = new Date(documentData.createdAt).toLocaleString();
        document.getElementById('updatedAt').textContent = new Date(documentData.updatedAt).toLocaleString();
        document.getElementById('documentStatus').textContent = getStatusText(documentData.status);
        document.getElementById('documentVersion').textContent = documentData.version || '1';
        document.getElementById('documentOwner').textContent = documentData.owner || '';

        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡æ¡£æ‰€æœ‰è€…
        isOwner = documentData.owner === currentUser.username;

        // å¦‚æœæ˜¯æ‰€æœ‰è€…ï¼Œæ˜¾ç¤ºåä½œè€…ç®¡ç†åŒºåŸŸ
        if (isOwner) {
            document.getElementById('collaboratorsSection').style.display = 'block';
            displayCollaborators(documentData.collaborators || []);
        }

        await checkUserRoleAndSetPermissions(currentUser.role);

        // é‡ç½®æ›´æ”¹çŠ¶æ€
		if (documentData.autoSaveContent) {
            isChanged = true;
            console.log('isChanged === true');
			document.getElementById('changeStatus').textContent = 'æœ‰æœªä¿å­˜çš„æ›´æ”¹';
            document.getElementById('changeStatus').style.color = '#dc3545';
        } else {
			isChanged = false;
			document.getElementById('changeStatus').textContent = 'æ— æ›´æ”¹';
			document.getElementById('changeStatus').style.color = '#666';
		}
    }

    // æ£€æŸ¥ç”¨æˆ·è§’è‰²å¹¶è®¾ç½®æƒé™
    async function checkUserRoleAndSetPermissions(userRole) {
        // å¦‚æœæ˜¯æŸ¥çœ‹è€…è§’è‰²ï¼Œç¦ç”¨ç¼–è¾‘åŠŸèƒ½
        if (userRole === 'VIEWER') {
            setViewerPermissions();
        }
    }

    // è®¾ç½®æŸ¥çœ‹è€…æƒé™ï¼ˆç¦ç”¨ç¼–è¾‘åŠŸèƒ½ï¼‰
    function setViewerPermissions() {
        // ç¦ç”¨æ–‡æ¡£æ ‡é¢˜è¾“å…¥æ¡†
        const titleInput = document.getElementById('title');
        titleInput.disabled = true;
        titleInput.placeholder = 'ä»…å¯æŸ¥çœ‹';

        // ç¦ç”¨å¯Œæ–‡æœ¬ç¼–è¾‘å™¨
        if (quill) {
            quill.disable();
            const editorContainer = document.querySelector('#richTextPanel .ql-editor');
            if (editorContainer) {
                editorContainer.style.cursor = 'not-allowed';
                editorContainer.style.opacity = '0.7';
            }
        }

        // ç¦ç”¨Markdownç¼–è¾‘å™¨
        if (easyMDE) {
            easyMDE.codemirror.setOption('readOnly', true);
            const markdownEditor = document.getElementById('markdownEditor');
            if (markdownEditor) {
                markdownEditor.style.cursor = 'not-allowed';
                markdownEditor.style.opacity = '0.7';
            }
        }

        // ç¦ç”¨ä¿å­˜ä¿®æ”¹æŒ‰é’®
        const saveButton = document.querySelector('.btn.btn-primary');
        if (saveButton) {
            saveButton.disabled = true;
            saveButton.style.cursor = 'not-allowed';
            saveButton.style.opacity = '0.7';
        }

        // ç¦ç”¨å–æ¶ˆæŒ‰é’®
        const cancelButton = document.querySelector('.btn.btn-outline');
        if (cancelButton) {
            cancelButton.disabled = true;
            cancelButton.style.cursor = 'not-allowed';
            cancelButton.style.opacity = '0.7';
        }

        // ç¦ç”¨åˆ é™¤æ–‡æ¡£æŒ‰é’®
        const deleteButton = document.querySelector('.btn.btn-delete');
        if (deleteButton) {
            deleteButton.disabled = true;
            deleteButton.style.cursor = 'not-allowed';
            deleteButton.style.opacity = '0.7';
        }

        // éšè—åä½œè€…ç®¡ç†åŒºåŸŸ
        document.getElementById('collaboratorsSection').style.display = 'none';

        // ç¦ç”¨åä½œè€…æ·»åŠ åŠŸèƒ½
        const collaboratorInput = document.getElementById('collaboratorUsername');
        const addCollaboratorButton = document.querySelector('.add-collaborator-form .btn');
        if (collaboratorInput) collaboratorInput.disabled = true;
        if (addCollaboratorButton) addCollaboratorButton.disabled = true;
    }

    // æ˜¾ç¤ºåä½œè€…åˆ—è¡¨
    function displayCollaborators(collaborators) {
        const collaboratorsList = document.getElementById('collaboratorsList');

        if (collaborators.length === 0) {
            collaboratorsList.innerHTML = '<div style="color: #666;">æš‚æ— åä½œè€…</div>';
            return;
        }

        let html = '';
        collaborators.forEach(collaborator => {
            html += `
                <div class="collaborator-tag">
                    ${collaborator}
                    ${isOwner ? `<span class="remove-collaborator" onclick="removeCollaborator('${collaborator}')">Ã—</span>` : ''}
                </div>
            `;
        });

        collaboratorsList.innerHTML = html;
    }

    // ä¿å­˜æ–‡æ¡£
    async function saveDocument() {
        const title = document.getElementById('title').value.trim();
        const documentId = document.getElementById('documentId').value;

        if (!title) {
            alert('è¯·è¾“å…¥æ–‡æ¡£æ ‡é¢˜');
            return;
        }

        const content = getCurrentContent();
        if (!content) {
            alert('è¯·è¾“å…¥æ–‡æ¡£å†…å®¹');
            return;
        }

        try {
            // æ˜¾ç¤ºä¿å­˜ä¸­çŠ¶æ€
            document.getElementById('savingIndicator').style.display = 'inline';

            const updateData = {
                title: title,
                content: content
            };

            const response = await documentAPI.updateDocument(documentId, updateData);

            if (response.success) {
                // é‡ç½®æ›´æ”¹çŠ¶æ€
                isChanged = false;
                document.getElementById('changeStatus').textContent = 'æ— æ›´æ”¹';
                document.getElementById('changeStatus').style.color = '#666';

                // æ˜¾ç¤ºä¿å­˜æˆåŠŸçŠ¶æ€
                document.getElementById('saveIndicator').style.display = 'inline';
                document.getElementById('savingIndicator').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('saveIndicator').style.display = 'none';
                }, 3000);

                // æ›´æ–°æ–‡æ¡£ä¿¡æ¯
                document.getElementById('documentVersion').textContent = response.data.version || '1';
                document.getElementById('updatedAt').textContent = new Date().toLocaleString();

                alert('æ–‡æ¡£ä¿å­˜æˆåŠŸï¼');
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + response.message);
                document.getElementById('savingIndicator').style.display = 'none';
            }
        } catch (error) {
            console.error('ä¿å­˜æ–‡æ¡£é”™è¯¯:', error);
            alert('ä¿å­˜å¤±è´¥: ' + error.message);
            document.getElementById('savingIndicator').style.display = 'none';
        }
    }

    // æ·»åŠ åä½œè€…
    async function addCollaborator() {
        const username = document.getElementById('collaboratorUsername').value.trim();

        if (!username) {
            alert('è¯·è¾“å…¥ç”¨æˆ·å');
            return;
        }

        try {
            // å…ˆæ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·ID
            const userResponse = await user.getProfileByUsername(username);

            if (!userResponse.success) {
                alert('ç”¨æˆ·ä¸å­˜åœ¨: ' + (userResponse.message || 'è¯·æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦æ­£ç¡®'));
                return;
            }

            const userId = userResponse.data.userId;
            if (!userId) {
                alert('æ— æ³•è·å–ç”¨æˆ·ID');
                return;
            }

            // æ·»åŠ åä½œè€…
            const response = await documentAPI.addCollaborator(currentDocumentId, userId);

            if (response.success) {
                alert('åä½œè€…æ·»åŠ æˆåŠŸï¼');
                document.getElementById('collaboratorUsername').value = '';
                // é‡æ–°åŠ è½½æ–‡æ¡£è¯¦æƒ…ä»¥æ›´æ–°åä½œè€…åˆ—è¡¨
                loadDocumentDetail(currentDocumentId);
            } else {
                alert('æ·»åŠ å¤±è´¥: ' + response.message);
            }
        } catch (error) {
            console.error('æ·»åŠ åä½œè€…é”™è¯¯:', error);
            alert('æ·»åŠ å¤±è´¥: ' + error.message);
        }
    }

    // ç§»é™¤åä½œè€…
    async function removeCollaborator(username) {
        if (!confirm(`ç¡®å®šè¦ç§»é™¤åä½œè€… "${username}" å—ï¼Ÿ`)) {
            return;
        }

        try {
            // æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·ID
            const userResponse = await user.getUserIdByUsername(username);

            if (!userResponse.success) {
                alert('ç”¨æˆ·ä¸å­˜åœ¨: ' + (userResponse.message || 'æ— æ³•æ‰¾åˆ°è¯¥ç”¨æˆ·'));
                return;
            }

            const userId = userResponse.data.userId;
            if (!userId) {
                alert('æ— æ³•è·å–ç”¨æˆ·ID');
                return;
            }

            // ç§»é™¤åä½œè€…
            const response = await documentAPI.removeCollaborator(currentDocumentId, userId);

            if (response.success) {
                alert('åä½œè€…ç§»é™¤æˆåŠŸï¼');
                // é‡æ–°åŠ è½½æ–‡æ¡£è¯¦æƒ…ä»¥æ›´æ–°åä½œè€…åˆ—è¡¨
                loadDocumentDetail(currentDocumentId);
            } else {
                alert('ç§»é™¤å¤±è´¥: ' + response.message);
            }
        } catch (error) {
            console.error('ç§»é™¤åä½œè€…é”™è¯¯:', error);
            alert('ç§»é™¤å¤±è´¥: ' + error.message);
        }
    }

    // åˆ é™¤æ–‡æ¡£
    async function deleteDocument() {
        const documentId = document.getElementById('documentId').value;
        const documentTitle = document.getElementById('title').value;

        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡æ¡£ "${documentTitle}" å—ï¼Ÿæ­¤æ“ä½œå°†æŠŠæ–‡æ¡£ç§»åˆ°å›æ”¶ç«™ã€‚`)) {
            return;
        }

        try {
            const response = await documentAPI.deleteDocument(documentId);

            if (response.success) {
                alert('æ–‡æ¡£åˆ é™¤æˆåŠŸï¼');
                // æ¸…ç†åä½œèµ„æº
                if (collaborationManager) {
                    collaborationManager.cleanup();
                }
                // è¿”å›åˆ°æ–‡æ¡£åˆ—è¡¨é¡µé¢
                window.location.href = 'my-documents.html';
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + response.message);
            }
        } catch (error) {
            console.error('åˆ é™¤æ–‡æ¡£é”™è¯¯:', error);
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
    }

    // è·å–çŠ¶æ€æ–‡æœ¬
    function getStatusText(status) {
        const statusMap = {
            'EXISTS': 'å­˜åœ¨',
            'DELETED': 'å·²åˆ é™¤'
        };
        return statusMap[status] || status;
    }

    // è¿”å›ä¸Šä¸€é¡µ
    async function goBack() {
        let currentUser = null;
        try {
            // è·å–å½“å‰ç”¨æˆ·çš„å®Œæ•´ä¿¡æ¯
            const userResponse = await user.getProfile();
            if (userResponse.success) {
                currentUser = userResponse.data;
            }
        } catch (error) {
            console.error('è·å–ç”¨æˆ·è§’è‰²å¤±è´¥:', error);
        }

        if (currentUser.role !== 'VIEWER') {
            if (isChanged) {
                console.log('go back -> isChanged === true');
                const shouldLeave = confirm('æ‚¨æœ‰æœªä¿å­˜çš„æ›´æ”¹ï¼Œç¡®å®šè¦ç¦»å¼€å—ï¼Ÿ');
                if (!shouldLeave) {
                    return;
                }
            }
        }

        // æ¸…ç†åä½œèµ„æº
        if (collaborationManager) {
            collaborationManager.cleanup();
        }

        window.history.back();
    }

    // é€€å‡ºç™»å½•
    function logout() {
        // æ¸…ç†åä½œèµ„æº
        if (collaborationManager) {
            collaborationManager.cleanup();
        }

        window.location.href = 'login.html';
    }

    // æ˜¾ç¤ºå¯¼å‡ºé€‰é¡¹
    function showExportOptions() {
        const exportOptions = document.getElementById('exportOptions');

        // æ ¹æ®æ–‡æ¡£ç±»å‹ç”Ÿæˆä¸åŒçš„å¯¼å‡ºé€‰é¡¹
        if (currentDocumentType === 'MARKDOWN') {
            exportOptions.innerHTML = `
                <div class="export-option" onclick="exportMarkdown('md')">
                    <i>ğŸ“„</i>
                    <div class="export-option-text">
                        <div class="export-option-title">å¯¼å‡ºä¸º Markdown (.md)</div>
                        <div class="export-option-desc">ä¿ç•™åŸå§‹Markdownæ ¼å¼ï¼Œé€‚åˆåœ¨å…¶ä»–Markdownç¼–è¾‘å™¨ä¸­æ‰“å¼€</div>
                    </div>
                </div>
                <div class="export-option" onclick="exportMarkdown('pdf')">
                    <i>ğŸ“Š</i>
                    <div class="export-option-text">
                        <div class="export-option-title">å¯¼å‡ºä¸º PDF (.pdf)</div>
                        <div class="export-option-desc">ç”Ÿæˆæ ¼å¼åŒ–çš„PDFæ–‡æ¡£ï¼Œé€‚åˆæ‰“å°å’Œåˆ†äº«</div>
                    </div>
                </div>
            `;
        } else if (currentDocumentType === 'RICH_TEXT') {
            exportOptions.innerHTML = `
                <div class="export-option" onclick="exportRichText('html')">
                    <i>ğŸŒ</i>
                    <div class="export-option-text">
                        <div class="export-option-title">å¯¼å‡ºä¸º HTML (.html)</div>
                        <div class="export-option-desc">ä¿ç•™å¯Œæ–‡æœ¬æ ¼å¼ï¼Œå¯åœ¨æµè§ˆå™¨ä¸­ç›´æ¥æŸ¥çœ‹</div>
                    </div>
                </div>
                <div class="export-option" onclick="exportRichText('pdf')">
                    <i>ğŸ“Š</i>
                    <div class="export-option-text">
                        <div class="export-option-title">å¯¼å‡ºä¸º PDF (.pdf)</div>
                        <div class="export-option-desc">ç”Ÿæˆæ ¼å¼åŒ–çš„PDFæ–‡æ¡£ï¼Œé€‚åˆæ‰“å°å’Œåˆ†äº«</div>
                    </div>
                </div>
            `;
        }

        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        exportModal.style.display = 'flex';
    }

    // å…³é—­å¯¼å‡ºæ¨¡æ€æ¡†
    function closeExportModal() {
        exportModal.style.display = 'none';
    }

    // å¯¼å‡ºMarkdownæ–‡æ¡£
    async function exportMarkdown(format) {
        closeExportModal();

        const title = document.getElementById('title').value.trim() || 'æœªå‘½åæ–‡æ¡£';
        const content = easyMDE.value();

        if (!content) {
            alert('æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
            return;
        }

        if (format === 'md') {
            // å¯¼å‡ºä¸º.mdæ–‡ä»¶
            const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}.md`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else if (format === 'pdf') {
            // å¯¼å‡ºä¸ºPDFæ–‡ä»¶
            await exportToPDF(title, content, 'markdown');
        }
    }

    // å¯¼å‡ºå¯Œæ–‡æœ¬æ–‡æ¡£
    async function exportRichText(format) {
        closeExportModal();

        const title = document.getElementById('title').value.trim() || 'æœªå‘½åæ–‡æ¡£';
        const content = quill.root.innerHTML;

        if (!content || content === '<p><br></p>') {
            alert('æ–‡æ¡£å†…å®¹ä¸ºç©ºï¼Œæ— æ³•å¯¼å‡º');
            return;
        }

        if (format === 'html') {
            // å¯¼å‡ºä¸º.htmlæ–‡ä»¶
            const htmlContent = `<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>${title}</title>
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; max-width: 800px; margin: 0 auto; }
        </style>
    </head>
    <body>
        <h1>${title}</h1>
        ${content}
    </body>
    </html>`;

            const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${title}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } else if (format === 'pdf') {
            // å¯¼å‡ºä¸ºPDFæ–‡ä»¶
            await exportToPDF(title, content, 'html');
        }
    }

    // å¯¼å‡ºä¸ºPDF
    async function exportToPDF(title, content, type) {
        try {
            // æ˜¾ç¤ºå¯¼å‡ºä¸­æç¤º
            alert('æ­£åœ¨ç”ŸæˆPDFï¼Œè¯·ç¨å€™...');

            // åŠ¨æ€åŠ è½½jsPDFå’Œhtml2canvasåº“
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
            await loadScript('https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js');

            const { jsPDF } = window.jspdf;

            // åˆ›å»ºä¸´æ—¶å…ƒç´ ç”¨äºPDFç”Ÿæˆ
            const tempElement = document.createElement('div');
            tempElement.style.position = 'absolute';
            tempElement.style.left = '-9999px';
            tempElement.style.top = '0';
            tempElement.style.width = '800px';
            tempElement.style.padding = '20px';
            tempElement.style.backgroundColor = 'white';

            if (type === 'markdown') {
                // å°†Markdownè½¬æ¢ä¸ºHTML
                tempElement.innerHTML = `
                    <h1 style="text-align: center; margin-bottom: 30px;">${title}</h1>
                    <div style="line-height: 1.6; font-family: Arial, sans-serif;">
                        ${marked.parse(content)}
                    </div>
                `;
            } else {
                // ç›´æ¥ä½¿ç”¨å¯Œæ–‡æœ¬HTMLå†…å®¹
                tempElement.innerHTML = `
                    <h1 style="text-align: center; margin-bottom: 30px;">${title}</h1>
                    <div style="line-height: 1.6; font-family: Arial, sans-serif;">
                        ${content}
                    </div>
                `;
            }

            document.body.appendChild(tempElement);

            // ä½¿ç”¨html2canvaså°†HTMLè½¬æ¢ä¸ºå›¾ç‰‡
            const canvas = await html2canvas(tempElement, {
                scale: 2, // æé«˜åˆ†è¾¨ç‡
                useCORS: true,
                logging: false
            });

            // ä»canvasåˆ›å»ºå›¾ç‰‡æ•°æ®
            const imgData = canvas.toDataURL('image/png');

            // åˆ›å»ºPDF
            const pdf = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            // è·å–PDFé¡µé¢å°ºå¯¸
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();

            // è®¡ç®—å›¾ç‰‡åœ¨PDFä¸­çš„å°ºå¯¸
            const imgWidth = pageWidth - 20; // ç•™å‡ºè¾¹è·
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            // æ·»åŠ å›¾ç‰‡åˆ°PDF
            let heightLeft = imgHeight;
            let position = 10; // åˆå§‹Yä½ç½®

            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            // å¦‚æœå†…å®¹è¶…è¿‡ä¸€é¡µï¼Œæ·»åŠ æ–°é¡µé¢
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight + 10;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            // ä¿å­˜PDF
            pdf.save(`${title}.pdf`);

            // æ¸…ç†ä¸´æ—¶å…ƒç´ 
            document.body.removeChild(tempElement);

        } catch (error) {
            console.error('PDFå¯¼å‡ºå¤±è´¥:', error);
            alert('PDFå¯¼å‡ºå¤±è´¥: ' + error.message);
        }
    }

    // åŠ¨æ€åŠ è½½è„šæœ¬
    function loadScript(src) {
        return new Promise((resolve, reject) => {
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½
            if (document.querySelector(`script[src="${src}"]`)) {
                resolve();
                return;
            }

            const script = document.createElement('script');
            script.src = src;
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
        });
    }

    // ä¾§è¾¹æ åˆ‡æ¢å‡½æ•°
    function toggleCommentSidebar() {
        const sidebar = document.getElementById('commentSidebar');
        if (sidebar) {
            sidebar.classList.toggle('active');
        }
    }

    function toggleTaskSidebar() {
        const sidebar = document.getElementById('taskSidebar');
        if (sidebar) {
            sidebar.classList.toggle('active');
        }
    }

    function toggleNotificationPanel() {
        const panel = document.getElementById('notificationPanel');
        if (panel) {
            panel.classList.toggle('active');
        }
    }

    // è¯„è®ºç›¸å…³å‡½æ•°
    async function addNewComment() {
        if (commentManager) {
            await commentManager.addNewComment();
        }
    }

    async function submitReply(commentId, button) {
        if (commentManager) {
            await commentManager.submitReply(commentId, button);
        }
    }

    function cancelReply(button) {
        if (commentManager) {
            commentManager.cancelReply(button);
        }
    }

    async function resolveComment(commentId) {
        if (commentManager) {
            await commentManager.resolveComment(commentId);
        }
    }

    async function deleteComment(commentId) {
        if (commentManager) {
            await commentManager.deleteComment(commentId);
        }
    }

    // ä»»åŠ¡ç›¸å…³å‡½æ•°
    function showCreateTaskModal() {
        if (taskManager) {
            taskManager.showCreateTaskModal();
        }
    }

    function closeCreateTaskModal() {
        if (taskManager) {
            taskManager.closeCreateTaskModal();
        }
    }

    function createNewTask() {
        if (taskManager) {
            taskManager.createNewTask();
        }
    }

    async function updateTaskStatus(taskId, status) {
        if (taskManager) {
            await taskManager.updateTaskStatus(taskId, status);
        }
    }

    // é€šçŸ¥ç›¸å…³å‡½æ•°
    async function markAsRead(notificationId) {
        if (notificationManager) {
            await notificationManager.markAsRead(notificationId);
        }
    }

    async function markAllAsRead() {
        if (notificationManager) {
            await notificationManager.markAllAsRead();
        }
    }

    async function deleteNotification(notificationId) {
        if (notificationManager) {
            await notificationManager.deleteNotification(notificationId);
        }
    }

    function showReplyForm(commentId) {
        if (commentManager) {
            commentManager.showReplyForm(commentId);
        }
    }

    // ä¼šè®®ç›¸å…³å‡½æ•°
    async function toggleVideoConferencePanel() {
        const panel = document.getElementById('videoConferencePanel');
        if (panel && panel.classList.contains('active')) {
            // å¦‚æœä¼šè®®é¢æ¿æ˜¯æ‰“å¼€çš„ï¼Œå…³é—­å®ƒ
            panel.classList.remove('active');
        } else {
            // å¦‚æœä¼šè®®é¢æ¿æ˜¯å…³é—­çš„ï¼Œæ˜¾ç¤ºä¼šè®®ç®¡ç†æ¨¡æ€æ¡†
            await showConferenceManagementModal();
        }
    }

    async function showConferenceManagementModal() {
        const modal = document.getElementById('conferenceManagementModal');
        if (modal) {
            modal.style.display = 'flex';
            // åŠ è½½å¯ç”¨ä¼šè®®åˆ—è¡¨
            if (window.videoConferenceManager) {
                await window.videoConferenceManager.loadDocumentConferences();
            }
        }
    }

    function closeConferenceManagementModal() {
        const modal = document.getElementById('conferenceManagementModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    function switchConferenceTab(tabName) {
        // éšè—æ‰€æœ‰æ ‡ç­¾å†…å®¹
        const tabContents = document.querySelectorAll('.tab-content');
        tabContents.forEach(tab => tab.classList.remove('active'));

        // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾å†…å®¹
        const selectedTab = document.getElementById(tabName + 'ConferenceTab');
        if (selectedTab) {
            selectedTab.classList.add('active');
        }
    }

    async function createConference() {
        const title = document.getElementById('conferenceTitleInput').value.trim();
        const description = document.getElementById('conferenceDescription').value.trim();
        const maxParticipants = parseInt(document.getElementById('maxParticipants').value) || 10;

        if (!title) {
            alert('è¯·è¾“å…¥ä¼šè®®æ ‡é¢˜');
            return;
        }

        if (window.videoConferenceManager) {
            const success = await window.videoConferenceManager.createConference(title, description, maxParticipants);
            if (success) {
                closeConferenceManagementModal();
            }
        }
    }

    async function joinConference(conferenceId) {
        if (window.videoConferenceManager) {
            const success = await window.videoConferenceManager.joinConference(conferenceId);
            if (success) {
                closeConferenceManagementModal();
            }
        }
    }

    async function sendChatMessage(event) {
        event.preventDefault();

        const chatInput = document.getElementById('chatInput');
        const content = chatInput.value.trim();

        if (content && window.videoConferenceManager) {
            await window.videoConferenceManager.sendChatMessage(content);
            chatInput.value = '';
        }
    }

    async function toggleVideo() {
        if (window.videoConferenceManager) {
            await window.videoConferenceManager.toggleVideo();
        }
    }

    async function toggleAudio() {
        if (window.videoConferenceManager) {
            await window.videoConferenceManager.toggleAudio();
        }
    }

    async function toggleScreenSharing() {
        if (window.videoConferenceManager) {
            await window.videoConferenceManager.toggleScreenSharing();
        }
    }

    async function leaveConference() {
        if (window.videoConferenceManager) {
            await window.videoConferenceManager.leaveConference();
        }
    }

    async function endConference() {
        if (window.videoConferenceManager && confirm('ç¡®å®šè¦ç»“æŸä¼šè®®å—ï¼Ÿæ‰€æœ‰å‚ä¸è€…éƒ½ä¼šè¢«è¸¢å‡ºä¼šè®®ã€‚')) {
            await window.videoConferenceManager.endConference();
        }
    }

    window.addEventListener('click', function(event) {
        if (event.target === exportModal) {
            closeExportModal();
        }

        // ä»»åŠ¡åˆ›å»ºæ¨¡æ€æ¡†
        const taskModal = document.getElementById('createTaskModal');
        if (event.target === taskModal) {
            closeCreateTaskModal();
        }

        // è§†é¢‘ä¼šè®®ç®¡ç†æ¨¡æ€æ¡†
        const modal = document.getElementById('conferenceManagementModal');
        if (event.target === modal) {
            closeConferenceManagementModal();
        }
    });

    // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
    window.addEventListener('beforeunload', function() {
        if (collaborationManager) {
            collaborationManager.cleanup();
        }
        if (videoConferenceManager) {
            videoConferenceManager.leaveConference();
        }
    });
</script>
</body>
</html>