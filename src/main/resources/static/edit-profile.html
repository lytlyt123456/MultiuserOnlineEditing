<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¼–è¾‘èµ„æ–™ - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>åä½œç¼–è¾‘ç³»ç»Ÿ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">ç¼–è¾‘èµ„æ–™</span>
                    <a href="dashboard.html" class="btn btn-secondary">è¿”å›å·¥ä½œå°</a>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="profile-container">
                <div class="profile-header">
                    <h2>ç¼–è¾‘ä¸ªäººèµ„æ–™</h2>
                </div>

                <div class="profile-form">
                    <form id="profileForm">
                        <div class="form-group">
                            <label for="fullName">å§“å</label>
                            <input type="text" id="fullName" name="fullName"
                                   placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                        </div>

                        <div class="form-group">
                            <label for="bio">ä¸ªäººç®€ä»‹</label>
                            <textarea id="bio" name="bio"
                                      placeholder="ä»‹ç»ä¸€ä¸‹è‡ªå·±å§..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="phone">æ‰‹æœºå·</label>
                            <input type="text" id="phone" name="phone"
                                   placeholder="è¯·è¾“å…¥æ‰‹æœºå·ç ">
                        </div>

                        <div class="form-group">
                            <label for="email">é‚®ç®±</label>
                            <input type="text" id="email" name="email"
                                   placeholder="è¯·è¾“å…¥é‚®ç®±">
                        </div>

                        <div class="avatar-section">
                            <h3 style="margin-bottom: 1rem;">å¤´åƒè®¾ç½®</h3>

                            <div class="avatar-preview" id="avatarPreview">
                                <!-- å¤´åƒé¢„è§ˆåŒºåŸŸï¼Œç”±JavaScriptåŠ¨æ€å¡«å…… -->
                            </div>

                            <div class="avatar-actions">
                                <input type="file" id="fileInput" accept="image/*">
                                <button type="button" onclick="document.getElementById('fileInput').click()"
                                        class="btn btn-outline">
                                    ğŸ“· é€‰æ‹©å›¾ç‰‡
                                </button>
                                <button type="button" onclick="removeAvatar()" class="btn btn-danger">
                                    ğŸ—‘ï¸ ç§»é™¤å¤´åƒ
                                </button>
                            </div>

                            <div class="field-hint">
                                æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæ–‡ä»¶å¤§å°ä¸è¶…è¿‡ 10MB
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                ä¿å­˜æ›´æ”¹
                            </button>
                        </div>
                    </form>

                    <div id="message" class="message"></div>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script>
    let currentAvatarFile = null;
    let currentAvatarPath = '';

    // é¡µé¢åŠ è½½æ—¶è·å–å¹¶å¡«å……ç”¨æˆ·ä¿¡æ¯
    document.addEventListener('DOMContentLoaded', async function() {
        if (!checkAuth()) {
            return;
        }

        await loadUserProfile();
        await displayAvatar();
        setupFileUpload();
    });

    // åŠ è½½ç”¨æˆ·èµ„æ–™å¹¶å¡«å……è¡¨å•
    async function loadUserProfile() {
        try {
            const response = await user.getProfile();
            console.log('ç”¨æˆ·èµ„æ–™å“åº”:', response);

            if (response.success && response.data) {
                const userData = response.data;
                fillFormWithUserData(userData);
                showMessage('ç”¨æˆ·èµ„æ–™åŠ è½½æˆåŠŸ', 'success');
            } else {
                showMessage('åŠ è½½ç”¨æˆ·èµ„æ–™å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·èµ„æ–™å¼‚å¸¸:', error);
            showMessage('åŠ è½½ç”¨æˆ·èµ„æ–™æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
        } finally {
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.textContent = 'ä¿å­˜æ›´æ”¹';
            submitBtn.disabled = false;
        }
    }

    // ä½¿ç”¨ç”¨æˆ·æ•°æ®å¡«å……è¡¨å•
    function fillFormWithUserData(userData) {
        // å¡«å……å§“å - å¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºæç¤ºæ–‡æœ¬
        const fullNameInput = document.getElementById('fullName');
        if (userData.full_name) {
            fullNameInput.value = userData.full_name;
        } else {
            fullNameInput.placeholder = 'è¯·è¾“å…¥æ‚¨çš„å§“å';
        }

        // å¡«å……ä¸ªäººç®€ä»‹ - å¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºæç¤ºæ–‡æœ¬
        const bioInput = document.getElementById('bio');
        if (userData.biography) {
            bioInput.value = userData.biography;
        } else {
            bioInput.placeholder = 'ä»‹ç»ä¸€ä¸‹è‡ªå·±å§...';
        }

        // å¡«å……æ‰‹æœºå· - å¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºæç¤ºæ–‡æœ¬
        const phoneInput = document.getElementById('phone');
        if (userData.phone) {
            phoneInput.value = userData.phone;
        } else {
            phoneInput.placeholder = 'è¯·è¾“å…¥æ‰‹æœºå·ç ';
        }

        // å¡«å……é‚®ç®± - å¦‚æœä¸ºç©ºåˆ™æ˜¾ç¤ºæç¤ºæ–‡æœ¬
        const emailInput = document.getElementById('email');
        if (userData.email) {
            emailInput.value = userData.email;
        } else {
            emailInput.placeholder = 'è¯·è¾“å…¥é‚®ç®±';
        }

        console.log('è¡¨å•å¡«å……å®Œæˆ:', {
            fullName: userData.full_name || 'ç©º',
            bio: userData.biography || 'ç©º',
            phone: userData.phone || 'ç©º'
        });
    }

    // åœ¨è¿›å…¥è¯¥é¡µé¢æ—¶æ˜¾ç¤ºç”¨æˆ·çš„å·²æœ‰å¤´åƒ
    async function displayAvatar() {
        let avatarPath = '';
        try {
            // ä»APIè·å–å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
            const response = await user.getProfile();
            console.log('è·å–ç”¨æˆ·èµ„æ–™å“åº”:', response);

            if (response.success && response.data) {
                const userData = response.data;
                console.log('user data', userData);
                avatarPath = userData.avatar_path || '';
                avatarPath = getFileNameFromPath(avatarPath);
                console.log('å¤´åƒè·¯å¾„:', avatarPath);
            } else {
                console.error('è·å–ç”¨æˆ·èµ„æ–™å¤±è´¥:', response.message);
                showErrorMessage('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥: ' + (response.message || 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥'));
            }
        } catch (error) {
            console.error('åŠ è½½ç”¨æˆ·ä¿¡æ¯å¼‚å¸¸:', error);
            showErrorMessage('åŠ è½½ç”¨æˆ·ä¿¡æ¯æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message);
        }

        const avatarPreview = document.getElementById('avatarPreview');

        if (avatarPath) {
            // æ˜¾ç¤ºç°æœ‰å¤´åƒ
            // å¤´åƒæ–‡ä»¶å¯ä»¥é€šè¿‡ /uploads/avatars/ è·¯å¾„è®¿é—®
			let host = '';
			if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
				host = 'http://localhost:8080';
			} else {
				host = `${window.location.protocol}//${window.location.host}`;
			}
            const avatarUrl = `${host}/uploads/avatars/${avatarPath}`;
            avatarPreview.innerHTML = `
                <img src="${avatarUrl}" alt="ç”¨æˆ·å¤´åƒ" class="avatar-image"
                     onerror="this.style.display='none'; document.getElementById('defaultAvatar').style.display='flex';">
                <div id="defaultAvatar" class="avatar-placeholder" style="display: none;">ğŸ‘¤</div>
            `;
            currentAvatarPath = avatarUrl;
        } else {
            // æ˜¾ç¤ºé»˜è®¤å¤´åƒå ä½ç¬¦
            avatarPreview.innerHTML = `
                <div class="avatar-placeholder">ğŸ‘¤</div>
                <div class="field-hint" style="margin-top: 0.5rem;">æš‚æ— å¤´åƒ</div>
            `;
        }
    }

    // ä»æ–‡ä»¶è·¯å¾„ä¸­æå–æ–‡ä»¶å
    function getFileNameFromPath(path) {
        if (!path) return '';
        return path.split('/').pop().split('\\').pop();
    }

    // è®¾ç½®æ–‡ä»¶ä¸Šä¼ ç›‘å¬
    function setupFileUpload() {
        const fileInput = document.getElementById('fileInput');

        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                // éªŒè¯æ–‡ä»¶ç±»å‹
                if (!file.type.startsWith('image/')) {
                    showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                    return;
                }

                // éªŒè¯æ–‡ä»¶å¤§å° (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    showMessage('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
                    return;
                }

                // é¢„è§ˆå›¾ç‰‡
                previewImage(file);
                currentAvatarFile = file;

                // ä¸Šä¼ å›¾ç‰‡
                // uploadAvatar(file);
            }
        });
    }

    // é¢„è§ˆå›¾ç‰‡
    function previewImage(file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const avatarPreview = document.getElementById('avatarPreview');
            avatarPreview.innerHTML = `
                <img src="${e.target.result}" alt="å¤´åƒé¢„è§ˆ" class="avatar-image">
            `;
        };
        reader.readAsDataURL(file);
    }

    function removeAvatarPreview() {
        const avatarPreview = document.getElementById('avatarPreview');
        avatarPreview.innerHTML = `
                <div class="avatar-placeholder">ğŸ‘¤</div>
                <div class="field-hint" style="margin-top: 0.5rem;">æš‚æ— å¤´åƒ</div>
            `;
    }

    // ä¸Šä¼ å¤´åƒ
    async function uploadAvatar(file) {
        try {
            const response = await user.uploadAvatar(file);

            console.log('å¤´åƒä¸Šä¼ å“åº”:', response);

            if (response.success) {
                showMessage('å¤´åƒä¸Šä¼ æˆåŠŸï¼', 'success');

                // æ›´æ–°æœ¬åœ°ç”¨æˆ·æ•°æ®
                await updateLocalUserData();
            } else {
                showMessage('å¤´åƒä¸Šä¼ å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } catch (error) {
            console.error('å¤´åƒä¸Šä¼ å¼‚å¸¸:', error);
            showMessage('å¤´åƒä¸Šä¼ æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
        }
    }

    // ç§»é™¤å¤´åƒ
    async function removeAvatar() {
        if (!currentAvatarFile && !currentAvatarPath) {
            showMessage('å½“å‰æ²¡æœ‰è®¾ç½®å¤´åƒ', 'info');
            return;
        }

        if (confirm('ç¡®å®šè¦ç§»é™¤å½“å‰å¤´åƒå—ï¼Ÿ')) {
            try {
                // è¿™é‡Œéœ€è¦å®ç°ç§»é™¤å¤´åƒçš„åç«¯API
                // const response = await user.removeAvatar();
                // console.log('è·å–ç”¨æˆ·èµ„æ–™å“åº”:', response);

                currentAvatarFile = null;
                currentAvatarPath = '';

                // æš‚æ—¶å…ˆé‡ç½®é¢„è§ˆ
                removeAvatarPreview();
                showMessage('å¤´åƒå·²ç§»é™¤', 'success');
            } catch (error) {
                console.error('ç§»é™¤å¤´åƒå¼‚å¸¸:', error);
                showMessage('ç§»é™¤å¤´åƒæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
            }
        }
    }


    // è¡¨å•æäº¤å¤„ç†
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.textContent;
        submitBtn.textContent = 'ä¿å­˜ä¸­...';
        submitBtn.disabled = true;

        const formData = {
            fullName: document.getElementById('fullName').value.trim(),
            bio: document.getElementById('bio').value.trim(),
            phone: document.getElementById('phone').value.trim(),
            email: document.getElementById('email').value.trim()
        };

        console.log('æäº¤çš„èµ„æ–™æ•°æ®:', formData);

        try {
            if (currentAvatarFile) {
                await uploadAvatar(currentAvatarFile);
            } else if (!currentAvatarPath) {
                try {
                    // è¿™é‡Œéœ€è¦å®ç°ç§»é™¤å¤´åƒçš„åç«¯API
                    const response = await user.removeAvatar();
                    console.log('è·å–ç”¨æˆ·èµ„æ–™å“åº”:', response);
                } catch (error) {
                    console.error('ç§»é™¤å¤´åƒå¼‚å¸¸:', error);
                    showMessage('ç§»é™¤å¤´åƒæ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
                }
            }

            const response = await user.updateProfile(formData);
            console.log('æ›´æ–°èµ„æ–™å“åº”:', response);

            if (response.success) {
                showMessage('èµ„æ–™æ›´æ–°æˆåŠŸï¼', 'success');
                // ä¿å­˜æ›´æ–°åçš„ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
                await updateLocalUserData();

                // 2ç§’åè¿”å›å·¥ä½œå°
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            } else {
                showMessage('æ›´æ–°å¤±è´¥: ' + (response.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            }
        } catch (error) {
            console.error('æ›´æ–°èµ„æ–™å¼‚å¸¸:', error);
            showMessage('æ›´æ–°èµ„æ–™æ—¶å‘ç”Ÿé”™è¯¯: ' + error.message, 'error');
        } finally {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    });

    // æ›´æ–°æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·æ•°æ®
    async function updateLocalUserData() {
        try {
            const response = await user.getProfile();
            if (response.success && response.data) {
                const currentUser = JSON.parse(localStorage.getItem('user') || '{}');
                // åˆå¹¶æ›´æ–°åçš„æ•°æ®
                const updatedUser = {
                    ...currentUser,
                    ...response.data
                };
                localStorage.setItem('user', JSON.stringify(updatedUser));
            }
        } catch (error) {
            console.error('æ›´æ–°æœ¬åœ°ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
        }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(text, type) {
        const messageEl = document.getElementById('message');
        messageEl.textContent = text;
        messageEl.className = `message ${type}`;
        messageEl.style.display = 'block';

        if (type === 'success') {
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 3000);
        } else {
            setTimeout(() => {
                messageEl.style.display = 'none';
            }, 5000);
        }
    }

    // è¿”å›ä¸Šä¸€é¡µ
    function goBack() {
        if (confirm('ç¡®å®šè¦æ”¾å¼ƒå·²åšçš„ä¿®æ”¹å—ï¼Ÿ')) {
            window.location.href = 'dashboard.html';
        }
    }

    // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–ï¼Œæä¾›å®æ—¶åé¦ˆ
    document.querySelectorAll('input, textarea').forEach(input => {
        input.addEventListener('input', function() {
            // ç§»é™¤é”™è¯¯çŠ¶æ€
            this.style.borderColor = '';

            // å¦‚æœç”¨æˆ·å¼€å§‹è¾“å…¥ï¼Œç§»é™¤placeholderæ ·å¼
            if (this.value.trim()) {
                this.classList.remove('empty-field');
            } else {
                this.classList.add('empty-field');
            }
        });

        input.addEventListener('focus', function() {
            this.style.borderColor = '#007bff';
        });

        input.addEventListener('blur', function() {
            this.style.borderColor = '';
        });
    });
</script>
</body>
</html>