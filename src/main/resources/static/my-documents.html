<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æ–‡æ¡£ - åä½œç¼–è¾‘ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/my-documents-style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>æˆ‘çš„æ–‡æ¡£ Â·</h1>
                <div class="user-info">
                    <span id="userWelcome">æ¬¢è¿</span>
                    <a href="dashboard.html" class="btn">è¿”å›å·¥ä½œå°</a>
                    <button onclick="logout()" class="btn">é€€å‡ºç™»å½•</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <!-- é¢åŒ…å±‘å¯¼èˆª -->
            <div class="breadcrumb" id="breadcrumb">
                <a href="#" onclick="loadRoot()">æ ¹ç›®å½•</a>
            </div>

            <!-- å½“å‰æ–‡ä»¶å¤¹ä¿¡æ¯ -->
            <div class="current-folder-info" id="currentFolderInfo" style="display: none;">
                <h3 id="currentFolderName"></h3>
                <p id="currentFolderDescription"></p>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="action-buttons">
                <button onclick="createDocument()" class="btn btn-primary">æ–°å»ºæ–‡æ¡£</button>
                <button onclick="createFolder()" class="btn btn-outline">æ–°å»ºæ–‡ä»¶å¤¹</button>
            </div>

            <!-- æ–‡ä»¶åˆ—è¡¨ -->
            <div id="fileList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script src="js/document.js"></script>
<script>
    let currentFolderId = null;
    let currentFolder = null;
    let breadcrumbStack = [];

    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€å¹¶åŠ è½½æ ¹ç›®å½•
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            return;
        }
        loadRoot();
    });

    // åŠ è½½æ ¹ç›®å½•
    async function loadRoot() {
        currentFolderId = null;
        currentFolder = null;
        breadcrumbStack = [];

        const breadcrumb = document.getElementById('breadcrumb');
        breadcrumb.innerHTML = '';

        hideFolderInfo();

        await loadFolderContents();
    }

    // åŠ è½½æ–‡ä»¶å¤¹å†…å®¹
    async function loadFolderContents() {
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';

        try {
            let folders = [];
            let documents = [];

            if (currentFolderId) {
                // åŠ è½½å­æ–‡ä»¶å¤¹å’Œå­æ–‡ä»¶
                const [foldersResponse, documentsResponse] = await Promise.all([
                    folderAPI.getSubFolders(currentFolderId),
                    folderAPI.getSubDocuments(currentFolderId)
                ]);

                if (foldersResponse.success) {
                    folders = foldersResponse.data.subFolders || [];
                }
                if (documentsResponse.success) {
                    documents = documentsResponse.data.subDocuments || [];
                }

                // åŠ è½½å½“å‰æ–‡ä»¶å¤¹è¯¦æƒ…
                const folderDetailResponse = await folderAPI.getFolderDetail(currentFolderId);
                if (folderDetailResponse.success) {
                    currentFolder = folderDetailResponse.data;
                    showFolderInfo(currentFolder);
                }
            } else {
                // åŠ è½½æ ¹ç›®å½•çš„æ–‡ä»¶å¤¹å’Œæ–‡ä»¶
                const [foldersResponse, documentsResponse] = await Promise.all([
                    folderAPI.getRootFolders(),
                    documentAPI.getRootDocuments()
                ]);

                if (foldersResponse.success) {
                    folders = foldersResponse.data.folders || [];
                }
                if (documentsResponse.success) {
                    documents = documentsResponse.data.documents || [];
                }
            }

            displayFileList(folders, documents);
        } catch (error) {
            console.error('åŠ è½½æ–‡ä»¶å¤¹å†…å®¹é”™è¯¯:', error);
            fileList.innerHTML = '<div class="empty-state">åŠ è½½å¤±è´¥: ' + error.message + '</div>';
        }
    }

    // æ˜¾ç¤ºæ–‡ä»¶å¤¹ä¿¡æ¯
    function showFolderInfo(folder) {
        const folderInfo = document.getElementById('currentFolderInfo');
        const folderName = document.getElementById('currentFolderName');
        const folderDescription = document.getElementById('currentFolderDescription');

        folderName.textContent = folder.name;
        folderDescription.textContent = folder.description || 'æš‚æ— æè¿°';
        folderInfo.style.display = 'block';
    }

    // éšè—æ–‡ä»¶å¤¹ä¿¡æ¯
    function hideFolderInfo() {
        document.getElementById('currentFolderInfo').style.display = 'none';
    }

    // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
    function displayFileList(folders, documents) {
        const fileList = document.getElementById('fileList');

        if (folders.length === 0 && documents.length === 0) {
            fileList.innerHTML = '<div class="empty-state">æ­¤æ–‡ä»¶å¤¹ä¸ºç©º</div>';
            return;
        }

        let html = '<div class="file-list">';

        // æ˜¾ç¤ºæ–‡ä»¶å¤¹
        folders.forEach(folder => {
            html += `
                <div class="file-item">
                    <div class="file-icon folder-icon">ğŸ“</div>
                    <div class="file-name">${escapeHtml(folder.name)}</div>
                    <div class="file-info">æ–‡ä»¶å¤¹</div>
                    <div class="file-info">${new Date(folder.updated_at).toLocaleDateString()}</div>
                    <div class="folder-actions">
                        <button class="btn-edit" onclick="enterFolder(${folder.id}, '${folder.name}')">è¿›å…¥</button>
                        <button class="btn-edit" onclick="editFolder(${folder.id})">ç¼–è¾‘</button>
                        <button class="btn-delete" onclick="deleteFolder(${folder.id}, '${folder.name}')">åˆ é™¤</button>
                    </div>
                </div>
            `;
        });

        // æ˜¾ç¤ºæ–‡æ¡£
        documents.forEach(document => {
            const docTypeIcon = document.type === 'MARKDOWN' ? 'ğŸ“' : 'ğŸ“„';
            html += `
                <div class="file-item" onclick="openDocument(${document.id})">
                    <div class="file-icon document-icon">${docTypeIcon}</div>
                    <div class="file-name">${escapeHtml(document.title)}</div>
                    <div class="file-info">${document.type === 'MARKDOWN' ? 'Markdown' : 'å¯Œæ–‡æœ¬'}</div>
                    <div class="file-info">${new Date(document.updatedAt).toLocaleDateString()}</div>
                    <div class="file-info">ç‰ˆæœ¬: ${document.version}</div>
                </div>
            `;
        });

        html += '</div>';
        fileList.innerHTML = html;
    }

    // è¿›å…¥æ–‡ä»¶å¤¹
    function enterFolder(folderId, folderName) {
		if (currentFolderId !== null) {
			breadcrumbStack.push({
				id: currentFolderId,
				name: currentFolder.name
			});
		}
        currentFolderId = folderId;
        updateBreadcrumb();
        loadFolderContents();
    }

    // ç¼–è¾‘æ–‡ä»¶å¤¹
    function editFolder(folderId) {
        window.location.href = `edit-folder.html?id=${folderId}`;
    }

    // åˆ é™¤æ–‡ä»¶å¤¹
    async function deleteFolder(folderId, folderName) {
        if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ä»¶å¤¹ "${folderName}" å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
            return;
        }

        try {
            const response = await folderAPI.deleteFolder(folderId);
            if (response.success) {
                alert('æ–‡ä»¶å¤¹åˆ é™¤æˆåŠŸ');
                loadFolderContents(); // é‡æ–°åŠ è½½å½“å‰æ–‡ä»¶å¤¹å†…å®¹
            } else {
                alert('åˆ é™¤å¤±è´¥: ' + response.message);
            }
        } catch (error) {
            console.error('åˆ é™¤æ–‡ä»¶å¤¹é”™è¯¯:', error);
            alert('åˆ é™¤å¤±è´¥: ' + error.message);
        }
    }

    // åˆ›å»ºæ–‡æ¡£
    function createDocument() {
        let url = 'create-document.html';
        if (currentFolderId) {
            url += `?folderId=${currentFolderId}`;
        }
        window.location.href = url;
    }

    // åˆ›å»ºæ–‡ä»¶å¤¹
    function createFolder() {
        let url = 'create-folder.html';
        if (currentFolderId) {
            url += `?parentId=${currentFolderId}`;
        }
        window.location.href = url;
    }

    // æ›´æ–°é¢åŒ…å±‘å¯¼èˆª
    function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        let html = '<a href="#" onclick="loadRoot()">æ ¹ç›®å½•</a>';
		
        breadcrumbStack.forEach(item => {
			console.log(item.name);
            html += ` / <a href="#" onclick="goToFolder(${item.id})">${escapeHtml(item.name)}</a>`;
        });

        breadcrumb.innerHTML = html;
    }

    // è·³è½¬åˆ°æŒ‡å®šæ–‡ä»¶å¤¹
    function goToFolder(folderId) {
        // æ‰¾åˆ°è¦è·³è½¬çš„ä½ç½®
        const index = breadcrumbStack.findIndex(item => item.id === folderId);
        if (index !== -1) {
            // æˆªæ–­å †æ ˆ
            breadcrumbStack = breadcrumbStack.slice(0, index);
            currentFolderId = folderId;
            updateBreadcrumb();
            loadFolderContents();
        }
    }

    // æ‰“å¼€æ–‡æ¡£
    function openDocument(documentId) {
        window.location.href = `edit-document.html?id=${documentId}`;
    }

    // HTMLè½¬ä¹‰å‡½æ•°
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
</script>
</body>
</html>