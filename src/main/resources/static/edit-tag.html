<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编辑标签 - 协作编辑系统</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/edit-tag-style.css">
</head>
<body>
<div class="dashboard">
    <header class="dashboard-header">
        <div class="container">
            <div class="dashboard-nav">
                <h1>编辑标签 ·</h1>
                <div class="user-info">
                    <span id="userWelcome">欢迎</span>
                    <a href="my-tags.html" class="btn">返回标签列表</a>
                    <button onclick="logout()" class="btn">退出登录</button>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard-main">
        <div class="container">
            <div class="form-container">
                <!-- 标签基本信息 -->
                <div class="tag-info" id="tagInfo">
                    <div class="tag-info-item">
                        <strong>创建时间:</strong> <span id="createdAt">加载中...</span>
                    </div>
                </div>

                <form id="editTagForm" onsubmit="return false;">
                    <div class="form-group">
                        <label for="name">标签名称 *</label>
                        <input type="text" id="name" placeholder="请输入标签名称" required maxlength="50">
                        <div class="form-help">标签名称不能超过50个字符，且不能与现有标签重复</div>
                        <div class="character-count">
                            <span id="nameCount">0</span>/50
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">标签描述</label>
                        <textarea id="description" placeholder="请输入标签描述（可选）" maxlength="100"></textarea>
                        <div class="form-help">标签描述不能超过100个字符</div>
                        <div class="character-count">
                            <span id="descriptionCount">0</span>/100
                        </div>
                    </div>

                    <!-- 隐藏的标签ID字段 -->
                    <input type="hidden" id="tagId">

                    <div class="action-buttons">
                        <button type="button" onclick="updateTag()" class="btn btn-primary">保存修改</button>
                        <button type="button" onclick="goBack()" class="btn btn-outline">取消</button>
                    </div>
                </form>

                <!-- 危险操作区域 -->
                <div class="danger-zone">
                    <h3>危险操作</h3>
                    <p>删除标签将永久移除该标签。如果标签正在被文档使用，则无法删除。</p>
                    <button type="button" onclick="deleteTag()" class="btn btn-delete">删除标签</button>
                </div>
            </div>
        </div>
    </main>
</div>

<script src="js/utils.js"></script>
<script src="js/auth.js"></script>
<script src="js/user.js"></script>
<script src="js/document.js"></script>
<script>
    let currentTagId = null;

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function() {
        if (!checkAuth()) {
            return;
        }

        // 获取URL参数中的标签ID
        const urlParams = new URLSearchParams(window.location.search);
        currentTagId = urlParams.get('id');

        if (!currentTagId) {
            alert('无效的标签ID');
            window.location.href = 'my-tags.html';
            return;
        }

        // 设置隐藏字段
        document.getElementById('tagId').value = currentTagId;

        // 加载标签详情
        loadTagDetail(currentTagId);
        setupCharacterCounters();
    });

    // 设置字符计数器
    function setupCharacterCounters() {
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const nameCount = document.getElementById('nameCount');
        const descriptionCount = document.getElementById('descriptionCount');

        nameInput.addEventListener('input', function() {
            nameCount.textContent = this.value.length;
        });

        descriptionInput.addEventListener('input', function() {
            descriptionCount.textContent = this.value.length;
        });
    }

    // 加载标签详情
    async function loadTagDetail(tagId) {
        try {
            const response = await tagAPI.getTagDetail(tagId);
            if (response.success) {
                const tag = response.data;
                populateForm(tag);
            } else {
                alert('加载标签详情失败: ' + response.message);
                window.location.href = 'my-tags.html';
            }
        } catch (error) {
            console.error('加载标签详情错误:', error);
            alert('加载标签详情失败: ' + error.message);
            window.location.href = 'my-tags.html';
        }
    }

    // 填充表单数据
    function populateForm(tag) {
        // 填充表单字段
        document.getElementById('name').value = tag.name || '';
        document.getElementById('description').value = tag.description || '';

        // 更新字符计数
        document.getElementById('nameCount').textContent = tag.name ? tag.name.length : 0;
        document.getElementById('descriptionCount').textContent = tag.description ? tag.description.length : 0;

        // 更新标签信息显示
        document.getElementById('createdAt').textContent = new Date(tag.created_at).toLocaleString();
    }

    // 更新标签
    async function updateTag() {
        const name = document.getElementById('name').value.trim();
        const description = document.getElementById('description').value.trim();
        const tagId = document.getElementById('tagId').value;

        if (!name) {
            alert('请输入标签名称');
            return;
        }

        if (name.length > 50) {
            alert('标签名称不能超过50个字符');
            return;
        }

        if (description.length > 100) {
            alert('标签描述不能超过100个字符');
            return;
        }

        try {
            const updateData = {
                name: name,
                description: description || ''
            };

            const response = await tagAPI.updateTag(tagId, updateData);

            if (response.success) {
                alert('标签更新成功！');
                // 重新加载标签详情以更新显示信息
                window.location.href = 'my-tags.html';
            } else {
                alert('更新失败: ' + response.message);
            }
        } catch (error) {
            console.error('更新标签错误:', error);
            alert('更新失败: ' + error.message);
        }
    }

    // 删除标签
    async function deleteTag() {
        const tagId = document.getElementById('tagId').value;
        const tagName = document.getElementById('name').value;

        if (!confirm(`确定要删除标签 "${tagName}" 吗？此操作不可撤销。`)) {
            return;
        }

        try {
            const response = await tagAPI.deleteTag(tagId);

            if (response.success) {
                alert('标签删除成功！');
                // 返回到标签列表页面
                window.location.href = 'my-tags.html';
            } else {
                alert('删除失败: ' + response.message);
            }
        } catch (error) {
            console.error('删除标签错误:', error);
            alert('删除失败: ' + error.message);
        }
    }

    // 返回上一页
    function goBack() {
        window.history.back();
    }
</script>
</body>
</html>